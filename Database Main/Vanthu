drop database main; 
create database main;
use main;
SET GLOBAL event_scheduler = ON;

					-- BANK INFORMATION -------------------------------------------
CREATE TABLE IF NOT EXISTS BRANCHES (
    branch_id VARCHAR(4) PRIMARY KEY, -- VD: HN, HCM
    branch_name VARCHAR(100),
    branch_address VARCHAR(255)
);




					-- CUSTOMER SYSTEM -----------------------------------
                    
                    
CREATE TABLE IF NOT EXISTS CUSTOMERS (
    cus_ID VARCHAR(18) PRIMARY KEY,
    cus_first_name VARCHAR(50),
    cus_last_name VARCHAR(50),
    cus_dob DATE,
    cus_email VARCHAR(50) UNIQUE,
    cus_address VARCHAR(100),
    cus_phone_num VARCHAR(15) UNIQUE,
    cus_sex ENUM('Male', 'Female'),
    cus_identification_id VARCHAR(20) UNIQUE,
    cus_join_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    branch_id VARCHAR(4),
    FOREIGN KEY (branch_id) REFERENCES BRANCHES(branch_id) ON DELETE SET NULL
);
CREATE TABLE CUSTOMERS_INDEX (
    branch_id VARCHAR(4),
    year CHAR(2),
    current_index INT,
    PRIMARY KEY (branch_id, year)
);
CREATE TABLE IF NOT EXISTS CUSTOMER_ACCOUNT_TYPES (
    cus_account_type_id VARCHAR(2) PRIMARY KEY,
    cus_account_type_name VARCHAR(30) NOT NULL UNIQUE -- Chưa pull vào git
);
CREATE TABLE IF NOT EXISTS CUSTOMER_ACCOUNTS (
    cus_account_id VARCHAR(17) primary key, -- DTNB[customer_account_type_id][2-digit year][7-digit index]
    cus_id VARCHAR(17),
    cus_account_status ENUM('Active', 'Temporarily Locked', 'Locked') DEFAULT 'Active', 
    opening_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    cus_account_type_id VARCHAR(2) ,
    
    FOREIGN KEY (cus_id) REFERENCES CUSTOMERS(cus_id) on delete cascade,
    FOREIGN KEY (cus_account_type_id) REFERENCES CUSTOMER_ACCOUNT_TYPES(cus_account_type_id) on delete set null
);
CREATE TABLE IF NOT EXISTS CUSTOMER_ACCOUNT_INDEX (
    cus_account_type_id VARCHAR(2),
    year CHAR(2),
    current_index INT DEFAULT 0,
    PRIMARY KEY (cus_account_type_id, year)
);
CREATE TABLE IF NOT EXISTS INTEREST_RATES (
    interest_rate_id TINYINT auto_increment PRIMARY KEY,
    interest_rate_val DECIMAL(5,3) NOT NULL 
		CHECK (interest_rate_val >0),
    cus_account_type_id VARCHAR(2) not null,
    min_balance INT(10) UNSIGNED,
    max_balance INT(10) UNSIGNED,
		CHECK (max_balance > min_balance) ,
    term INT(2),
    status ENUM('Active', 'Inactive') DEFAULT "Active",
	
    FOREIGN KEY (cus_account_type_id) REFERENCES CUSTOMER_ACCOUNT_TYPES(cus_account_type_id) on delete cascade
);
CREATE TABLE SAVING_ACCOUNTS(
    cus_account_id VARCHAR(17) primary key,
    interest_rate_id TINYint ,
    saving_acc_balance bigint unsigned not null,
    
    FOREIGN KEY (cus_account_id) REFERENCES CUSTOMER_ACCOUNTS(cus_account_id),
    FOREIGN KEY (interest_rate_id) REFERENCES INTEREST_RATES(interest_rate_id)
);
CREATE TABLE CHECK_ACCOUNTS(
    cus_account_id VARCHAR(17) primary key,
  --   check_acc_balance bigint unsigned not null,
	check_acc_balance bigint not null,
    interest_rate_id TINYint,
    transfer_limit int unsigned default 100000000
		CHECK (transfer_limit <= 100000000) ,
	daily_transfer_limit BIGint unsigned,
        
    FOREIGN KEY (cus_account_id) REFERENCES CUSTOMER_ACCOUNTS(cus_account_id),
    FOREIGN KEY (interest_rate_id) REFERENCES INTEREST_RATES(interest_rate_id)
);
CREATE TABLE FIXED_DEPOSIT_ACCOUNTS(
    cus_account_id VARCHAR(17) PRIMARY KEY,
    interest_rate_id tinyint,
    deposit_amount bigint 
		CHECK (deposit_amount>1000),
    deposit_date DATE ,
    maturity_date DATE ,
		CHECK (maturity_date > deposit_date),
        
    FOREIGN KEY (cus_account_id) REFERENCES CUSTOMER_ACCOUNTS(cus_account_id) ON DELETE CASCADE,
    FOREIGN KEY (interest_rate_id) REFERENCES INTEREST_RATES(interest_rate_id) ON DELETE SET NULL
);

DELIMITER $$

CREATE TRIGGER after_insert_customer_account
AFTER INSERT ON CUSTOMER_ACCOUNTS
FOR EACH ROW
BEGIN
    DECLARE matched_interest_id TINYINT;

    -- Trường hợp: CHECK ACCOUNT
    IF NEW.cus_account_type_id = 'C' THEN
        SELECT interest_rate_id INTO matched_interest_id
        FROM INTEREST_RATES
        WHERE cus_account_type_id = 'C'
          AND status = 'Active'
        ORDER BY interest_rate_val DESC
        LIMIT 1;

        -- INSERT INTO CHECK_ACCOUNTS (cus_account_id, check_acc_balance, interest_rate_id, transfer_limit, daily_transfer_limit)
        INSERT INTO CHECK_ACCOUNTS (cus_account_id, check_acc_balance, interest_rate_id)
        VALUES (NEW.cus_account_id, 0, matched_interest_id);

    -- Trường hợp: SAVING ACCOUNT
    ELSEIF NEW.cus_account_type_id = 'S' THEN
        SELECT interest_rate_id INTO matched_interest_id
        FROM INTEREST_RATES
        WHERE cus_account_type_id = 'S'
          AND status = 'Active'
        ORDER BY interest_rate_val DESC
        LIMIT 1;

        INSERT INTO SAVING_ACCOUNTS (cus_account_id, saving_acc_balance, interest_rate_id)
        VALUES (NEW.cus_account_id, 0, matched_interest_id);

    -- Trường hợp: FIXED DEPOSIT ACCOUNT
    ELSEIF NEW.cus_account_type_id = 'F' THEN
        SELECT interest_rate_id INTO matched_interest_id
        FROM INTEREST_RATES
        WHERE cus_account_type_id = 'F'
          AND status = 'Active'
          AND term = 6
        ORDER BY interest_rate_val DESC
        LIMIT 1;

        INSERT INTO FIXED_DEPOSIT_ACCOUNTS (cus_account_id, interest_rate_id, deposit_date, maturity_date)
        VALUES (
            NEW.cus_account_id,
            matched_interest_id,
            CURRENT_DATE(),
            DATE_ADD(CURRENT_DATE(), INTERVAL 6 MONTH)
        );
    END IF;
END $$

DELIMITER ;





					-- TRANSACTIONS SYSTEM --------------------------------------------
                    
CREATE TABLE TRANSACTION_TYPES(
    trans_type_id VARCHAR(3) PRIMARY KEY,
    trans_type_name VARCHAR(30) NOT NULL,
    description TEXT
);
-- Thêm các mã lỗi cơ bản có thể phát hiện bằng trigger
CREATE TABLE TRANSACTION_ERROR_CODES (
    trans_error_code VARCHAR(10) PRIMARY KEY,
    trans_error_name VARCHAR(50) NOT NULL UNIQUE,
    description TEXT NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    can_retry BOOLEAN DEFAULT FALSE,
    needs_human_review BOOLEAN DEFAULT FALSE
);


CREATE TABLE TRANSACTIONS (
    trans_id VARCHAR(18) PRIMARY KEY, --  DTNB[transactin_type_id][2-digit year][7-digit index][day]
    trans_type_id varchar(3),
    cus_account_id VARCHAR(17) ,
	related_cus_account_id VARCHAR(17) ,
    trans_amount INT NOT NULL
		CHECK (trans_amount >= 1000),
	direction ENUM('Debit', 'Credit') NOT NULL,
    trans_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_updated DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    trans_status enum("Failed", "Successful") DEFAULT 'Successful',
	trans_error_code VARCHAR(10),
    
	FOREIGN KEY (trans_error_code) REFERENCES TRANSACTION_ERROR_CODES(trans_error_code) ON DELETE SET NULL,
	FOREIGN KEY (cus_account_id) REFERENCES CUSTOMER_ACCOUNTS(cus_account_id) ON DELETE SET NULL,
	FOREIGN KEY (trans_type_id) REFERENCES TRANSACTION_TYPES(trans_type_id) ON DELETE SET NULL
	)	;

 CREATE TABLE FAILED_TRANSACTIONS (
    trans_id VARCHAR(18) PRIMARY KEY,
    cus_account_id VARCHAR(17),
    trans_error_code VARCHAR(10) NOT NULL,
    trans_amount INT unsigned NOT NULL,
    failure_reason TEXT NOT NULL,
    attempted_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (trans_error_code) REFERENCES TRANSACTION_ERROR_CODES(trans_error_code) ON DELETE CASCADE,
	FOREIGN KEY (trans_id) REFERENCES TRANSACTIONS(trans_id) ON DELETE CASCADE, 
    FOREIGN KEY (cus_account_id) REFERENCES CUSTOMER_ACCOUNTS(cus_account_id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS TRANSACTION_INDEX (
    trans_type_id VARCHAR(3),
    year_suffix CHAR(2),
    current_index INT DEFAULT 0,
    PRIMARY KEY (trans_type_id, year_suffix)
);
DELIMITER //

CREATE TRIGGER validate_transaction_before_insert
BEFORE INSERT ON TRANSACTIONS
FOR EACH ROW
BEGIN
    DECLARE v_account_status VARCHAR(20);
    DECLARE v_balance BIGINT;
    DECLARE v_dest_account_status VARCHAR(20);
    DECLARE v_daily_total DECIMAL(18,2);
    DECLARE v_daily_limit DECIMAL(18,2);
    DECLARE v_transaction_limit int;
    
 

    
    -- Check balance for Debit transactions
    IF NEW.direction = 'Debit' THEN
        SELECT 
            CASE 
                WHEN ca.cus_account_type_id = 'S' THEN sa.saving_acc_balance
                WHEN ca.cus_account_type_id = 'C' THEN ca2.check_acc_balance
                ELSE 0
            END INTO v_balance
        FROM CUSTOMER_ACCOUNTS ca
        LEFT JOIN SAVING_ACCOUNTS sa ON ca.cus_account_id = sa.cus_account_id
        LEFT JOIN CHECK_ACCOUNTS ca2 ON ca.cus_account_id = ca2.cus_account_id
        WHERE ca.cus_account_id = NEW.cus_account_id;
        
        IF v_balance < NEW.trans_amount THEN
            SET NEW.trans_status = 'Failed';
            SET NEW.trans_error_code = 'BAL-001';
            -- SIGNAL SQLSTATE '45004' SET MESSAGE_TEXT = 'Insufficient balance'; 
        END IF;
    END IF;
     IF NEW.trans_type_id = 'TRF' AND NEW.direction = 'Debit' THEN
        -- Tổng số tiền đã chuyển trong ngày (chỉ tính giao dịch thành công)
        SELECT COALESCE(SUM(trans_amount), 0) INTO v_daily_total
        FROM TRANSACTIONS
        WHERE cus_account_id = NEW.cus_account_id
        AND DATE(trans_time) = DATE(NEW.trans_time)
        AND direction = 'Debit'
        AND trans_status = 'Successful';

        -- Lấy giới hạn ngày
        SELECT daily_transfer_limit INTO v_daily_limit
        FROM CHECK_ACCOUNTS
        WHERE cus_account_id = NEW.cus_account_id;

        IF (v_daily_total + NEW.trans_amount) > v_daily_limit THEN
            SET NEW.trans_status = 'Failed';
            SET NEW.trans_error_code = 'LIMIT-002';
        END IF;
        END IF;
         -- Lấy giới hạn từng giao dịch
        SELECT transfer_limit INTO v_transaction_limit
        FROM CHECK_ACCOUNTS
        WHERE cus_account_id = NEW.cus_account_id;

        IF NEW.trans_amount > v_transaction_limit THEN
            SET NEW.trans_status = 'Failed';
            SET NEW.trans_error_code = 'LIMIT-001';
        END IF;
    -- Kiểm tra hạn mức giao dịch trong ngày nếu là chuyển tiền Debit
   -- Check for same source and destination accounts
    IF NEW.trans_type_id = 'TRF' AND NEW.related_cus_account_id = NEW.cus_account_id THEN
        SET NEW.trans_status = 'Failed';
        SET NEW.trans_error_code = 'VAL-001';
        -- SIGNAL SQLSTATE '45001' SET MESSAGE_TEXT = 'Cannot transfer to the same account';
    END IF;
         -- Check if destination account exists (for transfer transactions)
    IF NEW.trans_type_id = 'TRF' THEN
        IF NOT EXISTS (
            SELECT 1
            FROM CUSTOMER_ACCOUNTS
            WHERE cus_account_id = NEW.related_cus_account_id
        ) THEN
            SET NEW.trans_status = 'Failed';
            SET NEW.trans_error_code = 'VAL-002';
    END IF;
    END IF;
    -- Check account status
    IF NEW.trans_type_id = 'TRF' THEN
        SELECT cus_account_status INTO v_dest_account_status 
        FROM CUSTOMER_ACCOUNTS 
        WHERE cus_account_id = NEW.related_cus_account_id;
        
        IF v_dest_account_status != 'Active' THEN
            SET NEW.trans_status = 'Failed';
            SET NEW.trans_error_code = 'ACC-001';
        END IF;
    END IF;
END;
//
DELIMITER ;

SELECT * FROM FAILED_TRANSACTIONS;

-- Trigger sau khi giao dịch thất bại
DELIMITER //
CREATE TRIGGER after_transaction_failed
AFTER INSERT ON TRANSACTIONS
FOR EACH ROW
BEGIN
    IF NEW.trans_status = 'Failed' 
    THEN
        INSERT INTO FAILED_TRANSACTIONS (
            trans_id,
            cus_account_id,
            trans_error_code,
            trans_amount,
            failure_reason,
            attempted_time
        ) VALUES (
            NEW.trans_id,
            NEW.cus_account_id,
            NEW.trans_error_code,
            NEW.trans_amount,
            COALESCE((SELECT description FROM TRANSACTION_ERROR_CODES WHERE trans_error_code = NEW.trans_error_code), 'Unknown error'),
            NEW.trans_time
        );
    END IF;
END//
DELIMITER ;


-- -------------------------------------------------------------------


					-- INTERNAL SYSTEM --------------------------------------------
                    
                    

CREATE TABLE IF NOT EXISTS EMPLOYEE_POSITIONS( -- TẠO BẢNG EMPLOYEE_POSITIONS
	emp_position_id VARCHAR(2) primary KEY, -- 'T', 'M', etc
    emp_position_name VARCHAR(15),
    description TEXT
);
CREATE TABLE IF NOT EXISTS EMPLOYEES (
    emp_id VARCHAR(11) PRIMARY KEY, -- [branch_id][position_id][2-digit year][4-digit index]
    emp_fullname VARCHAR(100) NOT NULL,
    emp_sex ENUM('Male', 'Female') NOT NULL,
    emp_dob DATE NOT NULL,
    emp_phone_num VARCHAR(15) UNIQUE NOT NULL, -- + [Mã quốc gia][Số còn lại] VD: +84 901238881
    emp_email VARCHAR(50) UNIQUE NOT NULL,
    emp_address VARCHAR(255) NOT NULL,
    emp_salary INT(9) UNSIGNED,
    branch_id VARCHAR(4),
    emp_join_date DATETIME DEFAULT current_timestamp,
    emp_position_id VARCHAR(2),
    
    FOREIGN KEY (branch_id) REFERENCES BRANCHES(branch_id) ON DELETE CASCADE,
    FOREIGN KEY (emp_position_id) REFERENCES EMPLOYEE_POSITIONS(emp_position_id) ON DELETE SET NULL
);
CREATE TABLE IF NOT EXISTS EMPLOYEE_ACCOUNT_INDEX (
	emp_position_id VARCHAR(2),
    branch_id VARCHAR(4),
    year CHAR(2),
    current_index INT DEFAULT 0,
    PRIMARY KEY (emp_position_id, branch_id, year)
);
CREATE TABLE IF NOT EXISTS SERVICE_TYPES (
    service_type_id VARCHAR(50) PRIMARY KEY,
    service_name VARCHAR(100) NOT NULL,
    description TEXT
);
CREATE TABLE IF NOT EXISTS EMPLOYEE_CUSTOMERS (
    emp_id VARCHAR(11),
    cus_id VARCHAR(17),
    service_type_id VARCHAR(50) NOT NULL,
    assigned_date DATE NOT NULL,
    
    PRIMARY KEY (emp_id, cus_id),
    FOREIGN KEY (emp_id) REFERENCES EMPLOYEES(emp_id) ON DELETE CASCADE,
    FOREIGN KEY (cus_id) REFERENCES CUSTOMERS(cus_id) ON DELETE CASCADE,
    FOREIGN KEY (service_type_id) REFERENCES SERVICE_TYPES(service_type_id) ON DELETE RESTRICT
);
CREATE TABLE EMPLOYEE_ACCOUNTS (
    emp_id VARCHAR(11) PRIMARY KEY,                                      
    username VARCHAR(100) NOT NULL UNIQUE,                 
    password_hash VARCHAR(255) NOT NULL,                   -- Hashed password (never store plaintext passwords)
    status ENUM('Active', 'Inactive', 'Temporarily Suspended', 'Permanently Suspended') DEFAULT 'Active',
    suspension_time DATETIME NULL,
    reactivation_time DATETIME NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,         
    
    FOREIGN KEY (emp_id) REFERENCES EMPLOYEEs(emp_id) ON DELETE CASCADE  
);
CREATE TABLE DEVICE_TYPES (
    device_type_id INT AUTO_INCREMENT PRIMARY KEY,
    device_type_name VARCHAR(50) NOT NULL UNIQUE,      -- Ví dụ: 'desktop', 'laptop', 'thin_client'
    is_portable BOOLEAN DEFAULT FALSE,          -- Có được mang ra ngoài không
    requires_approval BOOLEAN DEFAULT TRUE,     -- Có cần IT duyệt không
    description TEXT
);
CREATE TABLE DEVICES (
    device_id INT AUTO_INCREMENT PRIMARY KEY,
    device_type_id INT NOT NULL,                        
    device_name VARCHAR(100) NOT NULL,
    mac_address VARCHAR(50) NOT NULL,
    ip_address VARCHAR(45),
    is_active BOOLEAN DEFAULT TRUE,
    is_approved BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_checked_at DATETIME,
    
    CONSTRAINT fk_type_device FOREIGN KEY (device_type_id) REFERENCES device_types(device_type_id)
);


							-- SYSTEM MANAGEMENT --------------------------------------------
                            
                            
CREATE TABLE SYSTEM_ACTIVITY_CATEGORIES (
    activity_category_id INT AUTO_INCREMENT PRIMARY KEY,      
    activity_category_name VARCHAR(30) unique,
    description TEXT                              
);
CREATE TABLE SYSTEM_ACTIVITIES_HISTORY (
    activity_id INT AUTO_INCREMENT PRIMARY KEY,
    activity_category_id INT NOT NULL,
    activity_time DATETIME NOT NULL,
    emp_id VARCHAR(11) ,
    device_id INT ,
    objective_id VARCHAR(20),
    old_value VARCHAR(15),
    new_value VARCHAR(15),
		CHECK (new_value != old_value),
    description TEXT,
    status ENUM('Successful', 'Failed') NOT NULL,
    
	FOREIGN KEY (activity_category_id) REFERENCES SYSTEM_ACTIVITY_CATEGORIES(activity_category_id) ON DELETE CASCADE,
	FOREIGN KEY (emp_id) REFERENCES EMPLOYEES(emp_id) ON DELETE SET NULL,
	FOREIGN KEY (device_id) REFERENCES DEVICES(device_id) ON DELETE SET NULL
);
CREATE TABLE INTERNAL_LOGIN_HISTORY (
    emp_id VARCHAR(11),
    login_time DATETIME NOT NULL,
    logout_time DATETIME,
    ip_address VARCHAR(45),
    device_id INT,
    PRIMARY KEY (emp_id, device_id, login_time),
    status ENUM('Successful', 'Failed') NOT NULL,
    failure_reason TEXT,
    
	FOREIGN KEY (emp_id) REFERENCES EMPLOYEES(emp_id) ON DELETE CASCADE,
	FOREIGN KEY (device_id) REFERENCES DEVICES(device_id) ON DELETE CASCADE
);
CREATE TABLE EMPLOYEE_ACCOUNTS_HISTORY (
    history_id INT AUTO_INCREMENT PRIMARY KEY,
    emp_id VARCHAR(11) NOT NULL,
    old_status ENUM('Active', 'Inactive', 'Temporarily Suspended', 'Permanently Suspended'),
    new_status ENUM('Active', 'Inactive', 'Temporarily Suspended', 'Permanently Suspended') NOT NULL,
    change_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    changed_by VARCHAR(11),
    reason TEXT,
    
    FOREIGN KEY (emp_id) REFERENCES EMPLOYEE_ACCOUNTS(emp_id) ON DELETE CASCADE
);
CREATE TABLE CUS_ACCOUNT_CHANGE_HISTORY (
    cus_account_id VARCHAR(17),
    change_time DATETIME NOT NULL,
    field_change VARCHAR(100) NOT NULL,
    new_value TEXT,
    old_value TEXT,
    
	PRIMARY KEY ( cus_account_id, change_time),
	FOREIGN KEY (cus_account_id) REFERENCES CUSTOMER_ACCOUNTS(cus_account_id) ON DELETE CASCADE
);

CREATE TABLE FRAUD_PATTERNS (
    fraud_pattern_id INT auto_increment PRIMARY KEY,
    fraud_pattern_name VARCHAR(100) UNIQUE NOT NULL,
    description TEXT
);
CREATE TABLE SUSPICIONS (
    suspicion_id int auto_increment primary key,
    trans_id VARCHAR(18) ,
    fraud_pattern_id INT,
    detected_time DATETIME(6),
    severity_level enum('Low', 'Medium', 'High') ,
    suspicion_status ENUM('Unresolved', 'Investigating', 'Resolved', 'False_positive') DEFAULT 'Unresolved',
    
	FOREIGN KEY (trans_id) REFERENCES TRANSACTIONs(trans_id) ,
	FOREIGN KEY (fraud_pattern_id) REFERENCES FRAUD_PATTERNS(fraud_pattern_id) ON DELETE CASCADE
);


					-- REPORT --------------------------------------------

CREATE TABLE REPORT (
    report_id INT AUTO_INCREMENT PRIMARY KEY,
    report_name VARCHAR(100) NOT NULL UNIQUE,
    report_description TEXT
);
CREATE TABLE REPORT_ACCESS (
    report_id INT,
    emp_position ENUM('D','M','T','A'),  -- Director, Manager, Teller, Auditor
    PRIMARY KEY (report_id, emp_position),
    FOREIGN KEY (report_id) REFERENCES REPORT(report_id)
);
CREATE TABLE REPORT_FILTER (
    report_id INT,
    filter_name VARCHAR(100),
    filter_type VARCHAR(50),
    is_required BOOLEAN,
    FOREIGN KEY (report_id) REFERENCES report(report_id)
);

-- Check nếu deposit_date ko ở trong tương lai---------------------------------------------------------
SET SQL_SAFE_UPDATES = 0;

CREATE TABLE IF NOT EXISTS DEBUG_LOG (
    id INT AUTO_INCREMENT PRIMARY KEY,
    msg TEXT,
    log_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
SELECT * FROM DEBUG_LOG;
CREATE TABLE TEMP_SUSPICIONS (
    trans_id VARCHAR(18),
    fraud_pattern_id INT,
    detected_time DATETIME,
    severity_level ENUM('Low', 'Medium', 'High'),
    processed BOOLEAN DEFAULT FALSE,
    foreign key (trans_id) REFERENCES TRANSACTIONS(trans_id)
);
select * from suspicions;


CREATE TABLE IF NOT EXISTS EVENT_LOG (
    log_time DATETIME DEFAULT NOW(),
    message TEXT
);

DELIMITER //
CREATE EVENT move_temp_to_suspicions
ON SCHEDULE EVERY 5 SECOND
DO
BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        INSERT INTO EVENT_LOG (message) VALUES (CONCAT('Error in move_temp_to_suspicions at ', NOW()));
    END;
    
    START TRANSACTION;
    
    INSERT INTO SUSPICIONS (trans_id, fraud_pattern_id, detected_time, severity_level)
    SELECT trans_id, fraud_pattern_id, detected_time, severity_level
    FROM TEMP_SUSPICIONS
    WHERE processed = FALSE; -- Optional limit for large datasets
    
    UPDATE TEMP_SUSPICIONS
    SET processed = TRUE
    WHERE processed = FALSE
    AND trans_id IN (SELECT trans_id FROM SUSPICIONS WHERE detected_time >= DATE_SUB(NOW(), INTERVAL 1 MINUTE));
    
    INSERT INTO EVENT_LOG (message) VALUES (CONCAT('Event ran at ', NOW()));
    
    COMMIT;
END//
DELIMITER ;


DELIMITER //
CREATE TRIGGER detect_amount_spike
AFTER INSERT ON TRANSACTIONS
FOR EACH ROW
BEGIN
    DECLARE yearly_avg DECIMAL(20,2) DEFAULT 0;
    DECLARE pattern_id INT DEFAULT NULL;
    DECLARE recent_trans_count INT DEFAULT 0;
    DECLARE recent_trans_total DECIMAL(20,2) DEFAULT 0;

    -- Bắt đầu ghi log để debug
    INSERT INTO DEBUG_LOG (msg) VALUES (CONCAT('Trigger fired for ', NEW.trans_id));

    IF NEW.trans_status = 'Successful' THEN

        SELECT fraud_pattern_id INTO pattern_id
        FROM FRAUD_PATTERNS
        WHERE fraud_pattern_name = 'Transaction Amount Spike'
        LIMIT 1;

        IF pattern_id IS NOT NULL THEN

            SELECT IFNULL(AVG(trans_amount), 0) INTO yearly_avg
            FROM TRANSACTIONS
            WHERE cus_account_id = NEW.cus_account_id
              AND trans_status = 'Successful'
              AND trans_time >= DATE_SUB(NEW.trans_time, INTERVAL 1 YEAR);

            SELECT COUNT(*), IFNULL(SUM(trans_amount), 0)
            INTO recent_trans_count, recent_trans_total
            FROM TRANSACTIONS
            WHERE cus_account_id = NEW.cus_account_id
              AND trans_status = 'Successful'
              AND trans_time BETWEEN DATE_SUB(NEW.trans_time, INTERVAL 15 MINUTE) AND NEW.trans_time;

            INSERT INTO DEBUG_LOG (msg) 
            VALUES (
                CONCAT('AVG=', yearly_avg, ', CNT=', recent_trans_count,  'TOTAL=', recent_trans_total, 'TRANS_TIME' , DATE_SUB(NEW.trans_time, INTERVAL 15 MINUTE))
            );

            IF yearly_avg > 0 AND recent_trans_count >= 5 AND recent_trans_total > (yearly_avg * 10) THEN
                INSERT INTO TEMP_SUSPICIONS (trans_id, fraud_pattern_id, detected_time, severity_level)
                VALUES (NEW.trans_id, pattern_id, NOW(), 'Low');

                INSERT INTO DEBUG_LOG (msg) VALUES (CONCAT('Suspicion inserted for ', NEW.trans_id));

            END IF;
        ELSE
            INSERT INTO DEBUG_LOG (msg) VALUES ('Pattern ID not found');
        END IF;
    ELSE
        INSERT INTO DEBUG_LOG (msg) VALUES ('Transaction not successful');
    END IF;
END//

DELIMITER ;


DELIMITER ;
-- Dormant acc activity trigger
DELIMITER //

CREATE TRIGGER detect_dormant_activity
AFTER INSERT ON TRANSACTIONS
FOR EACH ROW
BEGIN
    DECLARE last_trans_date DATETIME;
    DECLARE pattern_id INT;
    
    -- Chỉ kiểm tra giao dịch thành công >= 50,000,000
    IF NEW.trans_status = 'Successful' AND NEW.trans_amount >= 50000000 THEN
        -- Lấy ID mẫu gian lận
        SELECT fraud_pattern_id INTO pattern_id 
        FROM FRAUD_PATTERNS 
        WHERE fraud_pattern_name = 'Dormant Account Activity';
        
        -- Lấy ngày giao dịch cuối cùng
        SELECT MAX(trans_time) INTO last_trans_date
        FROM TRANSACTIONS
        WHERE cus_account_id = NEW.cus_account_id
        AND trans_id != NEW.trans_id
        AND trans_status = 'Successful';
        
        -- Kiểm tra tài khoản không hoạt động >3 tháng
        IF last_trans_date IS NOT NULL AND DATEDIFF(NEW.trans_time, last_trans_date) > 90 THEN
            -- Thêm vào bảng SUSPICIONS với severity_level tạm thời
            INSERT INTO TEMP_SUSPICIONS (trans_id, fraud_pattern_id, detected_time, severity_level)
            VALUES (NEW.trans_id, pattern_id, NOW(), 'Low');
            
            -- Log thông tin vào DEBUG_LOG
            INSERT INTO DEBUG_LOG (msg) 
            VALUES (CONCAT('Suspicion detected for ', NEW.trans_id, ': Dormant Account Activity, Account: ', NEW.cus_account_id, ', Transaction Date: ', NEW.trans_time));
        END IF;
    END IF;
END//
DELIMITER ;

CREATE TABLE SUSPICIONS_PENDING_UPDATE (
    trans_id VARCHAR(18),
    fraud_pattern_id INT,
    detected_time DATETIME,
    severity_level ENUM('Low', 'Medium', 'High'),
    PRIMARY KEY (trans_id, fraud_pattern_id, detected_time)
);

-- *severity level update
DELIMITER //

CREATE TRIGGER update_severity_based_on_violations
AFTER INSERT ON SUSPICIONS
FOR EACH ROW
BEGIN
    DECLARE violation_count INT;
    DECLARE account_id VARCHAR(17);
    DECLARE new_severity ENUM('Low', 'Medium', 'High');

    -- Lấy account ID liên quan
    SELECT cus_account_id INTO account_id
    FROM TRANSACTIONS
    WHERE trans_id = NEW.trans_id;

    -- Đếm số lần vi phạm (không tính False_positive)
    SELECT COUNT(*) INTO violation_count
    FROM SUSPICIONS s
    JOIN TRANSACTIONS t ON s.trans_id = t.trans_id
    WHERE t.cus_account_id = account_id
    AND s.suspicion_status != 'False_positive'
    AND s.fraud_pattern_id = NEW.fraud_pattern_id;

    -- Xác định mức độ nghiêm trọng
    SET new_severity = CASE
        WHEN violation_count >= 3 THEN 'High'
        WHEN violation_count = 2 THEN 'Medium'
        ELSE 'Low'
    END;

    -- Gửi dữ liệu cập nhật sang bảng trung gian
    INSERT INTO SUSPICIONS_PENDING_UPDATE (trans_id, fraud_pattern_id, detected_time, severity_level)
    VALUES (NEW.trans_id, NEW.fraud_pattern_id, NEW.detected_time, new_severity)
    ON DUPLICATE KEY UPDATE severity_level = VALUES(severity_level);

    -- Gọi thủ tục khóa tài khoản nếu cần
    CALL check_and_lock_account(account_id);
END//
DELIMITER ;
select * from suspicions;

DELIMITER //
CREATE EVENT apply_pending_severity_updates
ON SCHEDULE EVERY 5 SECOND
DO
BEGIN
    START TRANSACTION;

    -- Áp dụng cập nhật mức độ nghiêm trọng
    UPDATE SUSPICIONS s
    JOIN SUSPICIONS_PENDING_UPDATE spu
    ON s.trans_id = spu.trans_id
       AND s.fraud_pattern_id = spu.fraud_pattern_id
       AND s.detected_time = spu.detected_time
    SET s.severity_level = spu.severity_level;

    -- Dọn bảng trung gian
    DELETE FROM SUSPICIONS_PENDING_UPDATE;

    COMMIT;
END//
DELIMITER ;
SELECT COUNT(*) FROM TEMP_SUSPICIONS WHERE processed = FALSE;

-- =====================================
########################################################
CREATE TABLE DEBUG_LOG_2 (
    log_id INT AUTO_INCREMENT PRIMARY KEY,
    log_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    account_id VARCHAR(17),
    current_status VARCHAR(20),
    high_severity_count INT,
    action_taken VARCHAR(100)
);

-- Lock account
DELIMITER //
CREATE PROCEDURE check_and_lock_account(IN p_account_id VARCHAR(17))
BEGIN
    DECLARE high_severity_count INT DEFAULT 0;
    DECLARE current_status VARCHAR(20);
    DECLARE action_msg VARCHAR(100);

    -- Lấy trạng thái hiện tại
    SELECT cus_account_status INTO current_status
    FROM CUSTOMER_ACCOUNTS
    WHERE cus_account_id = p_account_id;

    -- Mặc định chưa có hành động
    SET action_msg = 'No action taken';

    -- Chỉ xử lý nếu tài khoản chưa bị khóa
    IF current_status = 'Active' THEN
        -- Đếm số nghi ngờ High severity (không tính False_positive)
        SELECT COUNT(*) INTO high_severity_count
        FROM SUSPICIONS s
        JOIN TRANSACTIONS t ON s.trans_id = t.trans_id
        WHERE t.cus_account_id = p_account_id
        AND s.severity_level = 'High'
        AND s.suspicion_status != 'False_positive';

        -- Khóa tài khoản nếu có >=3 High severity
        IF high_severity_count >= 3 THEN
            UPDATE CUSTOMER_ACCOUNTS
            SET cus_account_status = 'Temporarily Locked'
            WHERE cus_account_id = p_account_id;

            SET action_msg = 'Account temporarily locked due to 3+ high severity suspicions';
        ELSE
            SET action_msg = 'Less than 3 high severity suspicions – no lock';
        END IF;
    ELSE
        SET action_msg = CONCAT('No action – status is ', current_status);
    END IF;

    -- Ghi log vào DEBUG_LOG_2
    INSERT INTO DEBUG_LOG_2 (account_id, current_status, high_severity_count, action_taken)
    VALUES (p_account_id, current_status, high_severity_count, action_msg);
END//
DELIMITER ;




DELIMITER //

CREATE TRIGGER update_balances_after_transaction
AFTER INSERT ON TRANSACTIONS
FOR EACH ROW
BEGIN
    DECLARE account_type VARCHAR(2);
    
    -- Chỉ xử lý khi giao dịch thành công
    IF NEW.trans_status = 'Successful' THEN
        -- Lấy loại tài khoản
        SELECT cus_account_type_id INTO account_type
        FROM CUSTOMER_ACCOUNTS
        WHERE cus_account_id = NEW.cus_account_id;
        
        -- Xử lý trừ tiền từ tài khoản nguồn (Debit)
        IF NEW.direction = 'Debit' THEN
            IF account_type = 'C' THEN -- Check account
                UPDATE CHECK_ACCOUNTS
                SET check_acc_balance = check_acc_balance - NEW.trans_amount
                WHERE cus_account_id = NEW.cus_account_id;
            ELSEIF account_type = 'S' THEN -- Saving account
                UPDATE SAVING_ACCOUNTS
                SET saving_acc_balance = saving_acc_balance - NEW.trans_amount
                WHERE cus_account_id = NEW.cus_account_id;
            END IF;
        END IF;
        
        -- Xử lý cộng tiền vào tài khoản đích (nếu có và là Credit)
        -- IF NEW.related_cus_account_id IS NOT NULL AND NEW.direction = 'Credit' THEN
        IF NEW.related_cus_account_id IS NOT NULL THEN
            SELECT cus_account_type_id INTO account_type
            FROM CUSTOMER_ACCOUNTS
            WHERE cus_account_id = NEW.related_cus_account_id;
            
            IF account_type = 'C' THEN -- Check account
                UPDATE CHECK_ACCOUNTS
                SET check_acc_balance = check_acc_balance + NEW.trans_amount
                WHERE cus_account_id = NEW.related_cus_account_id;
            ELSEIF account_type = 'S' THEN -- Saving account
                UPDATE SAVING_ACCOUNTS
                SET saving_acc_balance = saving_acc_balance + NEW.trans_amount
                WHERE cus_account_id = NEW.related_cus_account_id;
            END IF;
        END IF;
    END IF;
END //

DELIMITER ;
DELIMITER //

CREATE PROCEDURE calculate_interest_for_accounts()
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE account_id VARCHAR(17);
    DECLARE acc_type VARCHAR(2);
    DECLARE balance BIGINT;
    DECLARE rate DECIMAL(5,3);
    DECLARE interest_amount DECIMAL(18,2);
    DECLARE term_months INT;
    
    -- Cursor cho tài khoản tiết kiệm (S)
    DECLARE saving_cursor CURSOR FOR 
        SELECT sa.cus_account_id, sa.saving_acc_balance, ir.interest_rate_val
        FROM SAVING_ACCOUNTS sa
        JOIN CUSTOMER_ACCOUNTS ca ON sa.cus_account_id = ca.cus_account_id
        JOIN INTEREST_RATES ir ON sa.interest_rate_id = ir.interest_rate_id
        WHERE ir.cus_account_type_id = 'S'
        AND ir.status = 'Active'
        AND ca.cus_account_status = 'Active';
    
    -- Cursor cho tài khoản tiền gửi có kỳ hạn (F)
    DECLARE fixed_cursor CURSOR FOR 
        SELECT fd.cus_account_id, fd.deposit_amount, ir.interest_rate_val, ir.term
        FROM FIXED_DEPOSIT_ACCOUNTS fd
        JOIN CUSTOMER_ACCOUNTS ca ON fd.cus_account_id = ca.cus_account_id
        JOIN INTEREST_RATES ir ON fd.interest_rate_id = ir.interest_rate_id
        WHERE ir.cus_account_type_id = 'F'
        AND ir.status = 'Active'
        AND ca.cus_account_status = 'Active'
        AND fd.maturity_date <= CURDATE();
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    -- Xử lý tài khoản tiết kiệm (hàng tháng)
    OPEN saving_cursor;
    saving_loop: LOOP
        FETCH saving_cursor INTO account_id, balance, rate;
        IF done THEN
            LEAVE saving_loop;
        END IF;
        
        -- Tính lãi hàng tháng (lãi suất năm chia 12)
        SET interest_amount = balance * (rate / 100 / 12);
        
        -- Cộng lãi vào tài khoản
        UPDATE SAVING_ACCOUNTS
        SET saving_acc_balance = saving_acc_balance + interest_amount
        WHERE cus_account_id = account_id;
        
        -- Ghi nhận giao dịch lãi
        INSERT INTO TRANSACTIONS (
            trans_id,
            trans_type_id,
            cus_account_id,
            trans_amount,
            direction,
            trans_status
        ) VALUES (
            CONCAT('INT', DATE_FORMAT(CURDATE(), '%y%m%d'), LPAD(account_id, 8, '0')),
            'INT',
            account_id,
            interest_amount,
            'Credit',
            'Successful'
        );
    END LOOP;
    CLOSE saving_cursor;
    
    SET done = FALSE;
    
    -- Xử lý tài khoản tiền gửi có kỳ hạn (khi đáo hạn)
    OPEN fixed_cursor;
    fixed_loop: LOOP
        FETCH fixed_cursor INTO account_id, balance, rate, term_months;
        IF done THEN
            LEAVE fixed_loop;
        END IF;
        
        -- Tính lãi theo kỳ hạn
        SET interest_amount = balance * (rate / 100) * (term_months / 12);
        
        -- Cộng lãi và gốc vào tài khoản tiết kiệm (hoặc check account)
        -- Giả sử chuyển vào tài khoản tiết kiệm cùng khách hàng
        UPDATE SAVING_ACCOUNTS sa
        JOIN CUSTOMER_ACCOUNTS ca ON sa.cus_account_id = (
            SELECT cus_account_id FROM CUSTOMER_ACCOUNTS 
            WHERE cus_id = (
                SELECT cus_id FROM CUSTOMER_ACCOUNTS 
                WHERE cus_account_id = account_id
            )
            AND cus_account_type_id = 'S'
            LIMIT 1
        )
        SET sa.saving_acc_balance = sa.saving_acc_balance + balance + interest_amount;
        
        -- Ghi nhận giao dịch lãi và gốc
        INSERT INTO TRANSACTIONS (
            trans_id,
            trans_type_id,
            cus_account_id,
            related_cus_account_id,
            trans_amount,
            direction,
            trans_status
        ) VALUES (
            CONCAT('MAT', DATE_FORMAT(CURDATE(), '%y%m%d'), LPAD(account_id, 8, '0')),
            'MAT',
            account_id,
            (SELECT cus_account_id FROM CUSTOMER_ACCOUNTS 
             WHERE cus_id = (SELECT cus_id FROM CUSTOMER_ACCOUNTS WHERE cus_account_id = account_id)
             AND cus_account_type_id = 'S' LIMIT 1),
            balance + interest_amount,
            'Credit',
            'Successful'
        );
        
        -- Đóng tài khoản tiền gửi có kỳ hạn
        DELETE FROM FIXED_DEPOSIT_ACCOUNTS WHERE cus_account_id = account_id;
        UPDATE CUSTOMER_ACCOUNTS SET cus_account_status = 'Locked' WHERE cus_account_id = account_id;
    END LOOP;
    CLOSE fixed_cursor;
END //

DELIMITER ;
-- Bật event scheduler nếu chưa bật
SET GLOBAL event_scheduler = ON;

-- Tạo event tính lãi tự động chạy vào 00:00 ngày đầu tháng
CREATE EVENT IF NOT EXISTS auto_calculate_interest
ON SCHEDULE 
    EVERY 1 MONTH
    STARTS TIMESTAMP(DATE_FORMAT(DATE_ADD(CURDATE(), INTERVAL 1 MONTH), '%Y-%m-01 00:00:00'))
DO
    CALL calculate_interest_for_accounts();
###################################################################################################
DELIMITER $$

CREATE TRIGGER trg_generate_customer_id
BEFORE INSERT ON CUSTOMERS
FOR EACH ROW
BEGIN
    DECLARE idx INT;
    DECLARE yy CHAR(2);

    -- Use cus_join_date year if given, otherwise use current date
    SET yy = DATE_FORMAT(IFNULL(NEW.cus_join_date, CURRENT_TIMESTAMP), '%y');

    -- Increase or initialize the index for (branch_id, year)
    INSERT INTO CUSTOMERS_INDEX(branch_id, year, current_index)
    VALUES (NEW.branch_id, yy, 1)
    ON DUPLICATE KEY UPDATE current_index = current_index + 1;

    -- Get the updated index
    SELECT current_index INTO idx
    FROM CUSTOMERS_INDEX
    WHERE branch_id = NEW.branch_id AND year = yy;

    -- Set the new customer ID
    SET NEW.cus_ID = CONCAT('DTNB', NEW.branch_id, yy, LPAD(idx, 7, '0'));
END$$

DELIMITER ;

DELIMITER $$

CREATE TRIGGER trg_generate_customer_account_id
BEFORE INSERT ON CUSTOMER_ACCOUNTS
FOR EACH ROW
BEGIN
    DECLARE idx INT;
    DECLARE yy CHAR(2);

    -- Ưu tiên opening_date nếu có, không thì lấy CURRENT_DATE
    SET yy = IFNULL(DATE_FORMAT(NEW.opening_date, '%y'), DATE_FORMAT(CURRENT_DATE, '%y'));

    INSERT INTO CUSTOMER_ACCOUNT_INDEX(cus_account_type_id, year, current_index)
    VALUES (NEW.cus_account_type_id, yy, 1)
    ON DUPLICATE KEY UPDATE current_index = current_index + 1;

    -- Lấy chỉ số mới
    SELECT current_index INTO idx
    FROM CUSTOMER_ACCOUNT_INDEX
    WHERE cus_account_type_id = NEW.cus_account_type_id AND year = yy;

    -- Tạo mã tài khoản: DTNB + Loại + Năm + Số thứ tự
    SET NEW.cus_account_id = CONCAT('DTNB', NEW.cus_account_type_id, yy, LPAD(idx, 7, '0'));
END$$
DELIMITER ;

DELIMITER $$
CREATE TRIGGER trg_generate_emp_id
BEFORE INSERT ON EMPLOYEES
FOR EACH ROW
BEGIN
    DECLARE idx INT;
    DECLARE yy CHAR(2);
	SET yy = IFNULL(DATE_FORMAT(NEW.emp_join_date, '%y'), DATE_FORMAT(CURRENT_DATE, '%y'));
    
    INSERT INTO EMPLOYEE_ACCOUNT_INDEX ( branch_id, emp_position_id, year, current_index)
    VALUES (NEW.branch_id, NEW.emp_position_id, yy, 1)
    ON DUPLICATE KEY UPDATE current_index = current_index + 1;

    -- Lấy chỉ số mới sau khi cập nhật
    SELECT current_index INTO idx
    FROM EMPLOYEE_ACCOUNT_INDEX
    WHERE branch_id = NEW.branch_id AND emp_position_id = NEW.emp_position_id AND year = yy;

    -- Tạo customer_ID
    SET NEW.emp_id = CONCAT(NEW.branch_id, NEW.emp_position_id,  yy, LPAD(idx, 4, '0'));
END$$

DELIMITER ;
DELIMITER $$
CREATE TRIGGER trg_generate_trans_id
BEFORE INSERT ON TRANSACTIONS
FOR EACH ROW
BEGIN
    DECLARE idx INT;
    DECLARE yy CHAR(2);
    SET yy = IFNULL(DATE_FORMAT(NEW.trans_time, '%y'), DATE_FORMAT(CURRENT_DATE, '%y'));

    -- Tăng chỉ số cho branch + year hoặc thêm mới
    INSERT INTO TRANSACTION_INDEX (trans_type_id, year_suffix, current_index)
    VALUES (NEW.trans_type_id, yy, 1)
    ON DUPLICATE KEY UPDATE current_index = current_index + 1;

    -- Lấy chỉ số mới sau khi cập nhật
    SELECT current_index INTO idx
    FROM TRANSACTION_INDEX
    WHERE trans_type_id= NEW.trans_type_id AND year_suffix = yy;

    -- Tạo customer_ID
    SET NEW.trans_id = CONCAT('DTNB', NEW.trans_type_id, yy, LPAD(idx, 7, '0'));
END$$

DELIMITER ;
use main;

###############################################################################################################################
INSERT INTO BRANCHES (branch_id, branch_name, branch_address) VALUES
('HN', 'Hanoi', '123 Lang Street, Dong Da District, Hanoi'),
('HCM', 'Ho Chi Minh City', '456 Le Loi Street, District 1, Ho Chi Minh City'),
('DN', 'Da Nang', '789 Nguyen Van Linh Street, Hai Chau District, Da Nang'),
('QN', 'Quang Ninh', '321 Tran Hung Dao Street, Ha Long City, Quang Ninh'),
('HP', 'Hai Phong', '101 Lach Tray Street, Ngo Quyen District, Hai Phong');

INSERT INTO TRANSACTION_TYPES (trans_type_id, trans_type_name, description)
VALUES
    ('POS', 'Point of Sale', 'Debit/credit card purchases at stores, online payments. Extremely frequent in retail banking.'),
    ('DEP', 'Deposit', 'Includes salary credit, cash deposits, check deposits.'),
    ('WDL', 'Withdrawal', 'ATM cash withdrawals or over-the-counter withdrawals.'),
    ('TRF', 'Transfer', 'Transfers between personal accounts or to other people/banks.'),
    ('PMT', 'Payment', 'Loan repayments, utility bill payments, subscriptions.'),
    ('ACH', 'Automated Clearing House', 'Payroll, insurance, recurring payments (e.g., Netflix, insurance).'),
    ('INT', 'Interest Credit', 'Monthly or quarterly interest accruals on savings accounts.'),
    ('FEE', 'Fee Charge', 'Service charges, ATM fees, late fees, etc.'),
    ('CHK', 'Check', 'Used more in business or older accounts (declining in use).'),
    ('REF', 'Refund', 'E-commerce or billing refunds (increasing in usage).');
INSERT INTO CUSTOMER_ACCOUNT_TYPES VALUES 
('S', 'Saving Account'),
('C', 'Checking Account'),
('F', 'Fixed Deposit Account');
INSERT INTO TRANSACTION_ERROR_CODES VALUES
('VAL-001', 'SAME ACCOUNT', 'Source and destination accounts are the same', TRUE, TRUE, FALSE),
('VAL-002', 'INVALID ACCOUNT', 'Destination accounts is invalid', TRUE, TRUE, FALSE),
('ACC-001', 'DESTINATION ACCOUNT LOCKED', 'The destination account has been locked', TRUE, FALSE, TRUE),
('BAL-001', 'INSUFFICIENT BALANCE', 'Insufficient account balance', TRUE, TRUE, FALSE),
('LIMIT-001', 'TRANSACTION LIMIT EXCEEDED', 'Exceeded the transaction limit', TRUE, FALSE, TRUE),
('LIMIT-002', 'DAILY TRANSACTION LIMIT EXCEEDED', 'Exceeded the daily transaction limit', TRUE, FALSE, TRUE);
INSERT INTO INTEREST_RATES (interest_rate_val, cus_account_type_id, min_balance, max_balance, status, term)
VALUES
(0.1, 'C', 0, NULL, 'Active', NULL),
(1.9, 'S', 100000, 1000000000, 'Active', NULL),
(4.8, 'F', 1000000, NULL, 'Active', 1),
(5.2, 'F', 1000000, NULL, 'Active', 6),
(5.5, 'F', 1000000, NULL, 'Inactive', 12);
INSERT INTO SERVICE_TYPES (service_type_id, service_name, description)
VALUES
    -- Core Banking Service Groups
    ('ACCT', 'Account Services', 'Opening, closing, and managing customer accounts'),
    ('CARD', 'Card Services', 'Issuance and management of debit/credit cards'),
    ('LOAN', 'Loan Services', 'Processing and management of loan products'),
    ('TRAN', 'Transaction Services', 'Handling deposits, withdrawals, and transfers'),
    ('CUST', 'Customer Support', 'Resolving inquiries and complaints'),
    ('OPS', 'Internal Operations', 'Back-office processes and reconciliations'),
    ('DIGI', 'Digital Banking', 'Online and mobile banking services'),
    ('INVT', 'Investment Services', 'Wealth management and investment products'),
    ('INSR', 'Insurance Services', 'Bank-linked insurance offerings'),
    ('COMP', 'Compliance Reporting', 'Regulatory and anti-fraud operations');
INSERT INTO EMPLOYEE_POSITIONS (emp_position_id, emp_position_name, description)
VALUES 
('T', 'Teller', 'Handles daily banking transactions'),
('M', 'Manager', 'Manages bank branch operations'),
('A', 'Auditor', 'Responsible for reviewing and auditing financial records'),
('C', 'CEO', 'Leads the entire bank, responsible for corporate strategy and executive decisions');
INSERT INTO DEVICE_TYPES (device_type_name, is_portable, requires_approval, description)
VALUES
    ('Desktop', FALSE, FALSE, 'Standard device for most office-based employees (e.g., tellers, customer service, loan officers).'),
    ('Laptop', TRUE, FALSE, 'For mobile employees, managers, auditors, or IT staff who may need to work remotely or across branches.'),
    ('Thin Client', FALSE, FALSE, 'Used in highly secure environments (e.g., call centers or branch service counters).'),
    ('Mobile Device', TRUE, TRUE, 'Typically for notifications, approvals (e.g., 2FA or digital signatures by senior staff).'),
    ('Admin Console', FALSE, TRUE, 'Used by system admins or database administrators to manage internal systems.');
INSERT INTO DEVICES (device_type_id, device_name, mac_address, ip_address, is_active, is_approved, created_at, last_checked_at)
VALUES
    -- Nhân viên 101 (IT Department)
    (1, 'PC-Accounting-01', '00:1A:2B:3C:4D:5E', '192.168.1.100', TRUE, TRUE, '2023-01-15 09:00:00', '2023-12-01 14:30:00'),
    (2, 'Laptop-IT-01', '00:1A:2B:3C:4D:5F', '192.168.1.101', TRUE, TRUE, '2023-01-16 10:00:00', '2023-12-01 14:35:00'),
    -- Nhân viên 205 (Giao dịch viên)
    (2, 'VM-Accounting-Backup', '00:1A:2B:3C:4D:60', '192.168.2.50', TRUE, TRUE, '2023-02-10 08:30:00', '2023-12-01 15:00:00'),
    (4, 'Samsung Galaxy S23', '00:1A:2B:3C:4D:61', NULL, TRUE, TRUE, '2023-02-12 13:15:00', '2023-12-01 15:05:00'),
    -- Nhân viên 307 (Quản lý chi nhánh)
    (3, 'ThinClient-01', '00:1A:2B:3C:4D:62', '192.168.3.20', TRUE, TRUE, '2023-03-05 11:20:00', '2023-12-01 16:00:00');
INSERT INTO FRAUD_PATTERNS (fraud_pattern_name, description)
VALUES 
('Transaction Amount Spike', 'More than 5 consecutive transaction in less than 15 minutes exceeds 10 times the average amount of that account over 1-year interval.(if these transaction amounts exceed 50000000'),
('Dormant Account Activity', 'An account that has not had transactions for more than 3 months suddenly has a large transaction. From 50,000,000');


######################################################
			-- CUSTOMERS --
######################################################
INSERT INTO CUSTOMERS (
    cus_first_name, cus_last_name, cus_dob, cus_email, cus_address,
    cus_phone_num, cus_sex, cus_identification_id, cus_join_date, branch_id
) VALUES
('Nguyễn Văn', 'An', '1990-05-15', 'an.nguyenvan@gmail.com', '12 Lang Ha Street, Dong Da District, Hanoi', '+84 98 765 4321', 'Male', '012345678901', '2022-06-01', 'HN'),
('Trần Thị', 'Bích', '1985-08-20', 'bich.tranth@gmail.com', '45 Nguyen Thi Minh Khai Street, District 1, Ho Chi Minh City', '+84 91 234 5678', 'Female', '023456789012', '2023-07-15', 'HCM'),
('Lê Văn', 'Cường', '1995-03-10', 'cuong.levan95@gmail.com', '89 Le Duan Street, Hai Chau District, Da Nang', '+84 92 345 6789', 'Male', '034567890123', '2013-06-11', 'DN'),
('Phạm Vân', 'Thư', '1992-07-25', 'thu.phamvan92@gmail.com', '134 Tran Quoc Nghien Street, Ha Long City, Quang Ninh', '+84 96 112 2334', 'Female', '045678901234', '2021-12-27', 'QN'),
('Nguyễn Phương', 'Đông', '1988-12-01', 'dong.nguyenphuong88@gmail.com', '210 Lach Tray Street, Ngo Quyen District, Hai Phong', '+84 97 998 8776', 'Male', '056789012345', '2023-01-01', 'HP'),
('Lê Ngọc', 'Bích', '1993-11-18', 'bich.lengoc93@gmail.com', '18 Giang Vo Street, Ba Dinh District, Hanoi', '+84 90 567 8912', 'Female', '067890123456', '2003-10-01', 'HN'),
('Hoàng Thị Thanh', 'Nhàn', '1980-04-30', 'nhan.hoangthithanh80@gmail.com', '20 Kim Ma Street, Ba Dinh District, Hanoi', '+84 93 456 7890', 'Female', '078901234567', '2003-06-01', 'HN');
INSERT INTO CUSTOMERS (
    cus_first_name, cus_last_name, cus_dob, cus_email, cus_address,
    cus_phone_num, cus_sex, cus_identification_id, branch_id
) VALUES
('Nguyễn Thị Thu', 'Trang', '1997-09-05', 'trang.nguyenthithu97@gmail.com', '67 Le Van Sy Street, District 3, Ho Chi Minh City', '+84 91 123 4567', 'Female', '089012345678', 'HCM');
select * from CUSTOMERS;

######################################################
			-- CUSTOMER ACCOUNTS --
######################################################
-- Nguyễn Văn An (HN): đầy đủ 3 loại 
INSERT INTO CUSTOMER_ACCOUNTS (cus_id, cus_account_status, cus_account_type_id, opening_date) VALUES
('DTNBHN220000001', 'Active', 'S', '2022-06-01'),
('DTNBHN220000001', 'Active', 'C', '2022-06-01'),
('DTNBHN220000001', 'Active', 'F', '2023-06-11');

-- Trần Thị Bích (HCM): có tiết kiệm + thanh toán
INSERT INTO CUSTOMER_ACCOUNTS (cus_id, cus_account_status, cus_account_type_id, opening_date) VALUES
('DTNBHCM230000001', 'Active', 'S','2023-06-01'),
('DTNBHCM230000001', 'Active', 'C', '2024-06-01');
-- Lê Văn Cường (DN): trẻ, chỉ có thanh toán
INSERT INTO CUSTOMER_ACCOUNTS (cus_id, cus_account_status, cus_account_type_id, opening_date) VALUES
('DTNBDN130000001', 'Active', 'C', '2013-06-01');
-- Phạm Vân Thư (QN): có tiết kiệm + tài khoản thanh toán bị khóa
INSERT INTO CUSTOMER_ACCOUNTS (cus_id, cus_account_status, cus_account_type_id, opening_date) VALUES
('DTNBQN210000001', 'Active', 'S', '2022-06-21'),
('DTNBQN210000001', 'Temporarily Locked', 'C', '2024-06-01');
-- Nguyễn Phương Đông (HP): chỉ gửi có kỳ hạn (Fixed)
INSERT INTO CUSTOMER_ACCOUNTS (cus_id, cus_account_status, cus_account_type_id, opening_date) VALUES
('DTNBHP230000001', 'Active', 'F', '2023-06-01');
-- Lê Ngọc Bích (HN): tiết kiệm + thanh toán
INSERT INTO CUSTOMER_ACCOUNTS (cus_id, cus_account_status, cus_account_type_id, opening_date) VALUES
('DTNBHN030000001', 'Active', 'S', '2003-06-01'),
('DTNBHN030000001', 'Active', 'C', '2012-06-01'),
('DTNBHN030000001', 'Active', 'C', '2022-06-01');
-- Hoàng Thị Thanh Nhàn (HN): chỉ tiết kiệm
INSERT INTO CUSTOMER_ACCOUNTS (cus_id, cus_account_status, cus_account_type_id, opening_date) VALUES
('DTNBHN030000002', 'Active', 'S', '2003-06-01');
-- Nguyễn Thị Thu Trang (HCM): tiết kiệm + có kỳ hạn
INSERT INTO CUSTOMER_ACCOUNTS (cus_id, cus_account_status, cus_account_type_id) VALUES
('DTNBHCM250000001', 'Active', 'S'),
('DTNBHCM250000001', 'Active', 'F');
SELECT * FROM CUSTOMER_ACCOUNTS;

UPDATE SAVING_ACCOUNTS
SET saving_acc_balance = CASE cus_account_id
    WHEN 'DTNBS030000001' THEN 50000000
    WHEN 'DTNBS030000002' THEN 6000000
    WHEN 'DTNBS220000001' THEN 1000000
    WHEN 'DTNBS220000002' THEN 2000000
    WHEN 'DTNBS230000001' THEN 3000000
    WHEN 'DTNBS250000001' THEN 4000000
    ELSE saving_acc_balance
END;
UPDATE CHECK_ACCOUNTS
SET 
    check_acc_balance = CASE cus_account_id
        WHEN 'DTNBC120000001' THEN 7000000
        WHEN 'DTNBC130000001' THEN 8000000
        WHEN 'DTNBC220000001' THEN 9000000
        WHEN 'DTNBC220000002' THEN 6000000
        WHEN 'DTNBC240000001' THEN 7500000
        WHEN 'DTNBC240000002' THEN 8500000
        ELSE check_acc_balance
    END,
    
    daily_transfer_limit = CASE cus_account_id
        WHEN 'DTNBC120000001' THEN 20000000
        WHEN 'DTNBC130000001' THEN 25000000
        WHEN 'DTNBC220000001' THEN 30000000
        WHEN 'DTNBC220000002' THEN 15000000
        WHEN 'DTNBC240000001' THEN 10000000
        WHEN 'DTNBC240000002' THEN 5000000
        ELSE daily_transfer_limit
    END;
UPDATE FIXED_DEPOSIT_ACCOUNTS
SET deposit_amount = CASE cus_account_id
    WHEN 'DTNBF230000001' THEN 10000000
    WHEN 'DTNBF230000002' THEN 15000000
    WHEN 'DTNBF250000001' THEN 20000000
    ELSE deposit_amount
END;

######################################################
			-- EMPLOYEES --
######################################################            
INSERT INTO EMPLOYEES (emp_fullname, emp_sex, emp_dob, emp_phone_num, emp_email, emp_address,  branch_id, emp_position_id, emp_join_date) VALUES
('Hoàng Ngọc Phương Vân', 'Female', '1970-01-01', '+84 986898689', 'ceo.hn@bank.com', '99 Phan Đình Phùng, Hà Nội',  'HN', 'C', '2010-01-15');
INSERT INTO EMPLOYEES (emp_fullname, emp_sex, emp_dob, emp_phone_num, emp_email, emp_address, emp_salary, branch_id, emp_position_id, emp_join_date) 
VALUES 
('Hoàng Thị Thanh Cuctar', 'Male', '1982-06-15', '+84 900000002', 'manager1.hn@bank.com', '15 Lý Thái Tổ, Hà Nội', 25000000, 'HN', 'M', '2015-03-10'),
('Trần Thị Quản Lý 2', 'Female', '1983-09-20', '+84 900000003', 'manager2.hn@bank.com', '23 Trần Hưng Đạo, Hà Nội', 25000000, 'HN', 'M', '2016-05-20'),
('Nguyễn Thị Giao Dịch 1', 'Female', '1990-01-10', '+84 900000004', 'teller1.hn@bank.com', '45 Đinh Tiên Hoàng, Hà Nội', 12000000, 'HN', 'T', '2018-02-15'),
('Trần Thị Giao Dịch 2', 'Female', '1992-03-25', '+84 900000005', 'teller2.hn@bank.com', '68 Tràng Thi, Hà Nội', 12000000, 'HN', 'T', '2019-04-05'),
('Lê Thị Giao Dịch 3', 'Female', '1993-07-11', '+84 900000006', 'teller3.hn@bank.com', '72 Lê Duẩn, Hà Nội', 12000000, 'HN', 'T', '2019-07-22'),
('Vũ Quang Giao Dịch 4', 'Male', '1991-05-20', '+84 900000007', 'teller4.hn@bank.com', '92 Nguyễn Du, Hà Nội', 12000000, 'HN', 'T', '2020-01-10'),
('Nguyễn Thị Giao Dịch 5', 'Female', '1994-11-30', '+84 900000008', 'teller5.hn@bank.com', '104 Bà Triệu, Hà Nội', 12000000, 'HN', 'T', '2020-03-18'),
('Lê Minh Giao Dịch 6', 'Male', '1991-10-10', '+84 900000009', 'teller6.hn@bank.com', '115 Nguyễn Thái Học, Hà Nội', 12000000, 'HN', 'T', '2020-06-30'),
('Trần Minh Giao Dịch 7', 'Male', '1990-12-01', '+84 900000010', 'teller7.hn@bank.com', '124 Phan Bội Châu, Hà Nội', 12000000, 'HN', 'T', '2021-02-14'),
('Nguyễn Minh Giao Dịch 8', 'Male', '1992-08-21', '+84 900000011', 'teller8.hn@bank.com', '135 Cầu Giấy, Hà Nội', 12000000, 'HN', 'T', '2021-05-20'),
('Nguyễn Quang Kiểm Toán 1', 'Male', '1984-03-15', '+84 900000012', 'auditor1.hn@bank.com', '150 Trường Chinh, Hà Nội', 18000000, 'HN', 'A', '2017-08-15'),
('Lê Quang Kiểm Toán 2', 'Male', '1985-06-25', '+84 900000013', 'auditor2.hn@bank.com', '160 Nguyễn Chí Thanh, Hà Nội', 17500000, 'HN', 'A', '2018-09-10'),
('Vũ Thị Kiểm Toán 3', 'Female', '1986-09-10', '+84 900000014', 'auditor3.hn@bank.com', '172 Trương Định, Hà Nội', 17000000, 'HN', 'A', '2019-11-05');

-- Chi nhánh Hồ Chí Minh - 6 nhân viên
INSERT INTO EMPLOYEES (emp_fullname, emp_sex, emp_dob, emp_phone_num, emp_email, emp_address, emp_salary, branch_id, emp_position_id, emp_join_date) VALUES
('Lee Ngọc Peach', 'Female', '1982-03-20', '+84 900000015', 'manager.hcm@bank.com', '55 Nguyễn Thị Minh Khai, HCM', 25000000, 'HCM', 'M', '2016-04-12'),
('Nguyễn Thị Giao Dịch 1', 'Female', '1990-11-30', '+84 900000016', 'teller1.hcm@bank.com', '45 Lê Lợi, HCM', 12000000, 'HCM', 'T', '2019-03-15'),
('Lê Minh Giao Dịch 2', 'Male', '1992-04-18', '+84 900000017', 'teller2.hcm@bank.com', '60 Cách Mạng Tháng 8, HCM', 12000000, 'HCM', 'T', '2019-06-20'),
('Phạm Thị Giao Dịch 3', 'Female', '1993-07-22', '+84 900000018', 'teller3.hcm@bank.com', '77 Nguyễn Huệ, HCM', 12000000, 'HCM', 'T', '2020-01-10'),
('Vũ Minh Giao Dịch 4', 'Male', '1991-05-14', '+84 900000019', 'teller4.hcm@bank.com', '89 Lý Tự Trọng, HCM', 12000000, 'HCM', 'T', '2020-03-25'),
('Nguyễn Quang Giao Dịch 5', 'Male', '1990-02-17', '+84 900000020', 'teller5.hcm@bank.com', '102 Đề Thám, HCM', 12000000, 'HCM', 'T', '2020-05-30'),
('Trương Thị Kiểm Toán 1', 'Female', '1984-07-10', '+84 900000021', 'auditor1.hcm@bank.com', '35 Nam Kỳ Khởi Nghĩa, HCM', 18000000, 'HCM', 'A', '2018-02-15'),
('Lê Thị Kiểm Toán 2', 'Female', '1986-11-15', '+84 900000022', 'auditor2.hcm@bank.com', '112 Đồng Khởi, HCM', 17500000, 'HCM', 'A', '2019-04-20');

-- Chi nhánh Đà Nẵng - 6 nhân viên
INSERT INTO EMPLOYEES(emp_fullname, emp_sex, emp_dob, emp_phone_num, emp_email, emp_address, emp_salary, branch_id, emp_position_id, emp_join_date) VALUES
('Nguyễn Văn Quản Lý', 'Male', '1984-02-20', '+84 900000023', 'manager.dn@bank.com', '12 Lê Duẩn, Đà Nẵng', 25000000, 'DN', 'M', '2017-05-10'),
('Trần Thị Giao Dịch 1', 'Female', '1990-11-15', '+84 900000024', 'teller1.dn@bank.com', '34 Hùng Vương, Đà Nẵng', 12000000, 'DN', 'T', '2019-08-12'),
('Lê Thị Giao Dịch 2', 'Female', '1993-05-30', '+84 900000025', 'teller2.dn@bank.com', '56 Trần Phú, Đà Nẵng', 12000000, 'DN', 'T', '2020-02-18'),
('Vũ Thị Giao Dịch 3', 'Female', '1994-08-14', '+84 900000026', 'teller3.dn@bank.com', '89 Lý Tự Trọng, Đà Nẵng', 12000000, 'DN', 'T', '2020-06-22'),
('Nguyễn Quang Giao Dịch 4', 'Male', '1991-07-18', '+84 900000027', 'teller4.dn@bank.com', '102 Nguyễn Hữu Thọ, Đà Nẵng', 12000000, 'DN', 'T', '2021-01-15'),
('Phạm Thị Giao Dịch 5', 'Female', '1992-03-20', '+84 900000028', 'teller5.dn@bank.com', '121 Phan Châu Trinh, Đà Nẵng', 12000000, 'DN', 'T', '2021-03-10'),
('Trương Quang Kiểm Toán 1', 'Male', '1985-09-12', '+84 900000029', 'auditor1.dn@bank.com', '45 Bạch Đằng, Đà Nẵng', 18000000, 'DN', 'A', '2018-10-05'),
('Lê Quang Kiểm Toán 2', 'Male', '1986-03-17', '+84 900000030', 'auditor2.dn@bank.com', '67 Hải Châu, Đà Nẵng', 17500000, 'DN', 'A', '2019-07-20');

-- Chi nhánh Hải Phòng - 5 nhân viên
INSERT INTO EMPLOYEES (emp_fullname, emp_sex, emp_dob, emp_phone_num, emp_email, emp_address, emp_salary, branch_id, emp_position_id, emp_join_date) VALUES
('Nguyễn Phương Dongiz', 'Female', '1981-11-30', '+84 900000031', 'manager.hp@bank.com', '123 Trần Phú, Hải Phòng', 25000000, 'HP', 'M', '2018-03-15'),
('Nguyễn Thị Giao Dịch 1', 'Female', '1992-05-12', '+84 900000032', 'teller1.hp@bank.com', '45 Lạch Tray, Hải Phòng', 12000000, 'HP', 'T', '2020-04-10'),
('Võ Thị Giao Dịch 2', 'Female', '1993-11-03', '+84 900000033', 'teller2.hp@bank.com', '68 Ngô Quyền, Hải Phòng', 12000000, 'HP', 'T', '2020-07-25'),
('Đặng Thị Giao Dịch 3', 'Female', '1991-10-17', '+84 900000034', 'teller3.hp@bank.com', '101 Cầu Đất, Hải Phòng', 12000000, 'HP', 'T', '2021-02-18'),
('Lê Minh Giao Dịch 4', 'Male', '1990-07-22', '+84 900000035', 'teller4.hp@bank.com', '25 Lê Chân, Hải Phòng', 12000000, 'HP', 'T', '2021-05-30'),
('Trần Quang Giao Dịch 5', 'Male', '1992-09-03', '+84 900000036', 'teller5.hp@bank.com', '77 Tôn Đức Thắng, Hải Phòng', 12000000, 'HP', 'T', '2021-08-15'),
('Vũ Thị Kiểm Toán 1', 'Female', '1984-12-13', '+84 900000037', 'auditor1.hp@bank.com', '99 Hoàng Minh Giám, Hải Phòng', 18000000, 'HP', 'A', '2019-06-20'),
('Nguyễn Thị Kiểm Toán 2', 'Female', '1985-08-21', '+84 900000038', 'auditor2.hp@bank.com', '134 Đinh Tiên Hoàng, Hải Phòng', 17500000, 'HP', 'A', '2020-01-10');

-- Chi nhánh Quảng Ninh - 5 nhân viên
INSERT INTO EMPLOYEES (emp_fullname, emp_sex, emp_dob, emp_phone_num, emp_email, emp_address, emp_salary, branch_id, emp_position_id, emp_join_date) VALUES
('Phạm Vân Thư', 'Female', '1983-04-15', '+84 900000039', 'manager.qn@bank.com', '34 Quang Trung, Quảng Ninh', 25000000, 'QN', 'M', '2019-02-10'),
('Phạm Văn Giao Dịch 1', 'Male', '1991-06-25', '+84 900000040', 'teller1.qn@bank.com', '45 Nguyễn Huệ, Quảng Ninh', 12000000, 'QN', 'T', '2020-05-15'),
('Lê Quang Giao Dịch 2', 'Male', '1992-02-18', '+84 900000041', 'teller2.qn@bank.com', '58 Hoàng Quốc Việt, Quảng Ninh', 12000000, 'QN', 'T', '2020-08-20'),
('Nguyễn Thị Giao Dịch 3', 'Female', '1993-11-29', '+84 900000042', 'teller3.qn@bank.com', '72 Cầu Đen, Quảng Ninh', 12000000, 'QN', 'T', '2021-01-12'),
('Trần Minh Giao Dịch 4', 'Male', '1990-08-11', '+84 900000043', 'teller4.qn@bank.com', '99 Cái Dăm, Quảng Ninh', 12000000, 'QN', 'T', '2021-04-05'),
('Vũ Minh Giao Dịch 5', 'Male', '1992-04-20', '+84 900000044', 'teller5.qn@bank.com', '23 Lý Thường Kiệt, Quảng Ninh', 12000000, 'QN', 'T', '2021-07-18'),
('Nguyễn Quang Kiểm Toán 1', 'Male', '1985-07-30', '+84 900000045', 'auditor1.qn@bank.com', '67 Cái Dăm, Quảng Ninh', 18000000, 'QN', 'A', '2020-03-10'),
('Lê Thị Kiểm Toán 2', 'Female', '1986-05-05', '+84 900000046', 'auditor2.qn@bank.com', '123 Bãi Cháy, Quảng Ninh', 17500000, 'QN', 'A', '2020-09-15');


-- ###########################################################
-- 2013-07-01 (1 transaction)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('POS', 'DTNBC130000001', NULL, 1300000, 'Debit', '2013-07-01 09:00:00', '2013-07-01 09:00:00'); -- Lê Văn Cường, Checking

-- 2014-01-01 (1 transaction)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('POS', 'DTNBC130000001', NULL, 1400000, 'Debit', '2014-01-01 10:00:00', '2014-01-01 10:00:00'); -- Lê Văn Cường, Checking

-- 2022-07-01 (4 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('POS', 'DTNBC220000001', NULL, 1500000, 'Debit', '2022-07-01 09:00:00', '2022-07-01 09:00:00'), -- Nguyễn Văn An, Checking
('DEP', 'DTNBS220000001', NULL, 5000000, 'Credit', '2022-07-01 09:00:00', '2022-07-01 09:00:00'), -- Nguyễn Văn An, Savings
('POS', 'DTNBC120000001', NULL, 1500000, 'Debit', '2022-07-01 09:00:00', '2022-07-01 09:00:00'), -- Lê Ngọc Bích, Checking
('POS', 'DTNBC220000002', NULL, 1200000, 'Debit', '2022-07-01 09:00:00', '2022-07-01 09:00:00'); -- Lê Ngọc Bích, Checking

-- 2022-08-01 (3 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('POS', 'DTNBC220000001', NULL, 2000000, 'Debit', '2022-08-01 10:00:00', '2022-08-01 10:00:00'), -- Nguyễn Văn An, Checking
('DEP', 'DTNBS220000001', NULL, 3000000, 'Credit', '2022-08-01 10:00:00', '2022-08-01 10:00:00'), -- Nguyễn Văn An, Savings
('POS', 'DTNBC120000001', NULL, 1300000, 'Debit', '2022-08-01 10:00:00', '2022-08-01 10:00:00'); -- Lê Ngọc Bích, Checking

-- 2022-09-01 (2 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('POS', 'DTNBC220000001', NULL, 1000000, 'Debit', '2022-09-01 11:00:00', '2022-09-01 11:00:00'), -- Nguyễn Văn An, Checking
('POS', 'DTNBC220000002', NULL, 1400000, 'Debit', '2022-09-01 11:00:00', '2022-09-01 11:00:00'); -- Lê Ngọc Bích, Checking

-- 2022-10-01 (2 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('POS', 'DTNBC220000001', NULL, 1200000, 'Debit', '2022-10-01 12:00:00', '2022-10-01 12:00:00'), -- Nguyễn Văn An, Checking
('POS', 'DTNBC120000001', NULL, 1300000, 'Debit', '2022-10-01 12:00:00', '2022-10-01 12:00:00'); -- Lê Ngọc Bích, Checking

-- 2022-11-01 (2 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('WDL', 'DTNBC220000001', NULL, 1000000, 'Debit', '2022-11-01 13:00:00', '2022-11-01 13:00:00'), -- Nguyễn Văn An, Checking
('WDL', 'DTNBC220000002', NULL, 1000000, 'Debit', '2022-11-01 13:00:00', '2022-11-01 13:00:00'); -- Lê Ngọc Bích, Checking

-- 2022-12-01 (3 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('WDL', 'DTNBC220000001', NULL, 1500000, 'Debit', '2022-12-01 14:00:00', '2022-12-01 14:00:00'), -- Nguyễn Văn An, Checking
('INT', 'DTNBS220000001', NULL, 100000, 'Credit', '2022-12-01 08:00:00', '2022-12-01 08:00:00'), -- Nguyễn Văn An, Savings
('INT', 'DTNBS030000001', NULL, 120000, 'Credit', '2022-12-01 08:00:00', '2022-12-01 08:00:00'); -- Lê Ngọc Bích, Savings

-- 2023-01-01 (4 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('TRF', 'DTNBC220000001', 'DTNBS220000001', 100000, 'Debit', '2023-01-01 15:00:00', '2023-01-01 15:00:00'), -- Nguyễn Văn An, Checking → Savings
('POS', 'DTNBC130000001', NULL, 1300000, 'Debit', '2023-01-01 09:00:00', '2023-01-01 09:00:00'), -- Lê Văn Cường, Checking
('DEP', 'DTNBS030000001', NULL, 5000000, 'Credit', '2023-01-01 09:00:00', '2023-01-01 09:00:00'), -- Lê Ngọc Bích, Savings
('DEP', 'DTNBS030000002', NULL, 6000000, 'Credit', '2023-01-01 09:00:00', '2023-01-01 09:00:00'); -- Hoàng Thị Thanh Nhàn, Savings
select * from CHECK_accounts;
select * from failed_transactions;

-- 2023-02-01 (4 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('TRF', 'DTNBC220000001', 'DTNBC240000002', 15000000, 'Debit', '2023-02-01 16:00:00', '2023-02-01 16:00:00'), -- Nguyễn Văn An, Checking → Phạm Vân Thư (before lock)
('POS', 'DTNBC130000001', NULL, 1400000, 'Debit', '2023-02-01 10:00:00', '2023-02-01 10:00:00'), -- Lê Văn Cường, Checking
('DEP', 'DTNBS030000001', NULL, 6000000, 'Credit', '2023-02-01 10:00:00', '2023-02-01 10:00:00'), -- Lê Ngọc Bích, Savings
('DEP', 'DTNBS030000002', NULL, 5000000, 'Credit', '2023-02-01 10:00:00', '2023-02-01 10:00:00'); -- Hoàng Thị Thanh Nhàn, Savings

-- 2023-03-01 (4 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('PMT', 'DTNBC220000001', NULL, 1000000, 'Debit', '2023-03-01 09:00:00', '2023-03-01 09:00:00'), -- Nguyễn Văn An, Checking
('POS', 'DTNBC130000001', NULL, 1500000, 'Debit', '2023-03-01 11:00:00', '2023-03-01 11:00:00'), -- Lê Văn Cường, Checking
('DEP', 'DTNBS030000001', NULL, 6000000, 'Credit', '2023-03-01 11:00:00', '2023-03-01 11:00:00'), -- Lê Ngọc Bích, Savings
('DEP', 'DTNBS030000002', NULL, 7000000, 'Credit', '2023-03-01 11:00:00', '2023-03-01 11:00:00'); -- Hoàng Thị Thanh Nhàn, Savings

-- 2023-04-01 (4 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('REF', 'DTNBC220000001', NULL, 1500000, 'Credit', '2023-04-01 10:00:00', '2023-04-01 10:00:00'), -- Nguyễn Văn An, Checking
('POS', 'DTNBC130000001', NULL, 1600000, 'Debit', '2023-04-01 12:00:00', '2023-04-01 12:00:00'), -- Lê Văn Cường, Checking
('WDL', 'DTNBS030000001', NULL, 1000000, 'Debit', '2023-04-01 12:00:00', '2023-04-01 12:00:00'), -- Lê Ngọc Bích, Savings
('DEP', 'DTNBS030000002', NULL, 4000000, 'Credit', '2023-04-01 12:00:00', '2023-04-01 12:00:00'); -- Hoàng Thị Thanh Nhàn, Savings

-- 2023-05-01 (4 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('POS', 'DTNBC130000001', NULL, 1700000, 'Debit', '2023-05-01 13:00:00', '2023-05-01 13:00:00'), -- Lê Văn Cường, Checking
('WDL', 'DTNBS030000001', NULL, 1100000, 'Debit', '2023-05-01 13:00:00', '2023-05-01 13:00:00'), -- Lê Ngọc Bích, Savings
('WDL', 'DTNBS030000002', NULL, 1100000, 'Debit', '2023-05-01 13:00:00', '2023-05-01 13:00:00'), -- Hoàng Thị Thanh Nhàn, Savings
('DEP', 'DTNBF230000001', NULL, 10000000, 'Credit', '2023-05-01 09:00:00', '2023-05-01 09:00:00'); -- Nguyễn Văn An, Fixed

-- 2023-06-01 (6 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('INT', 'DTNBS220000001', NULL, 120000, 'Credit', '2023-06-01 08:00:00', '2023-06-01 08:00:00'), -- Nguyễn Văn An, Savings
('POS', 'DTNBC130000001', NULL, 1800000, 'Debit', '2023-06-01 14:00:00', '2023-06-01 14:00:00'), -- Lê Văn Cường, Checking
('INT', 'DTNBS030000001', NULL, 120000, 'Credit', '2023-06-01 08:00:00', '2023-06-01 08:00:00'), -- Lê Ngọc Bích, Savings
('INT', 'DTNBS030000002', NULL, 130000, 'Credit', '2023-06-01 08:00:00', '2023-06-01 08:00:00'), -- Hoàng Thị Thanh Nhàn, Savings
('POS', 'DTNBC240000001', NULL, 1400000, 'Debit', '2023-06-01 09:00:00', '2023-06-01 09:00:00'), -- Trần Thị Bích, Checking
('DEP', 'DTNBF230000002', NULL, 8000000, 'Credit', '2023-06-01 09:00:00', '2023-06-01 09:00:00'); -- Nguyễn Phương Đông, Fixed

-- 2023-07-01 (6 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('WDL', 'DTNBC130000001', NULL, 1000000, 'Debit', '2023-07-01 15:00:00', '2023-07-01 15:00:00'), -- Lê Văn Cường, Checking
('WDL', 'DTNBS030000002', NULL, 1000000, 'Debit', '2023-07-01 15:00:00', '2023-07-01 15:00:00'), -- Hoàng Thị Thanh Nhàn, Savings
('DEP', 'DTNBS230000001', NULL, 6000000, 'Credit', '2023-07-01 09:00:00', '2023-07-01 09:00:00'), -- Trần Thị Bích, Savings
('FEE', 'DTNBF230000002', NULL, 50000, 'Debit', '2023-07-01 09:00:00', '2023-07-01 09:00:00'), -- Nguyễn Phương Đông, Fixed
('DEP', 'DTNBF230000001', NULL, 8000000, 'Credit', '2023-07-01 09:00:00', '2023-07-01 09:00:00'), -- Nguyễn Văn An, Fixed
('WDL', 'DTNBS220000001', NULL, 1500000, 'Debit', '2023-07-01 12:00:00', '2023-07-01 12:00:00'); -- Nguyễn Văn An, Savings

-- 2023-08-01 (6 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('WDL', 'DTNBC130000001', NULL, 1100000, 'Debit', '2023-08-01 16:00:00', '2023-08-01 16:00:00'), -- Lê Văn Cường, Checking
('PMT', 'DTNBC220000001', NULL, 1000000, 'Debit', '2023-08-01 16:00:00', '2023-08-01 16:00:00'), -- Nguyễn Văn An, Checking
('REF', 'DTNBC220000002', NULL, 1500000, 'Credit', '2023-08-01 16:00:00', '2023-08-01 16:00:00'), -- Lê Ngọc Bích, Checking
('WDL', 'DTNBS030000002', NULL, 1100000, 'Debit', '2023-08-01 16:00:00', '2023-08-01 16:00:00'), -- Hoàng Thị Thanh Nhàn, Savings
('DEP', 'DTNBS230000001', NULL, 4000000, 'Credit', '2023-08-01 10:00:00', '2023-08-01 10:00:00'), -- Trần Thị Bích, Savings
('FEE', 'DTNBF230000002', NULL, 60000, 'Debit', '2023-08-01 10:00:00', '2023-08-01 10:00:00'); -- Nguyễn Phương Đông, Fixed

-- 2023-09-01 (5 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('INT', 'DTNBF230000001', NULL, 200000, 'Credit', '2023-09-01 08:00:00', '2023-09-01 08:00:00'), -- Nguyễn Văn An, Fixed
('WDL', 'DTNBC130000001', NULL, 1200000, 'Debit', '2023-09-01 09:00:00', '2023-09-01 09:00:00'), -- Lê Văn Cường, Checking
('WDL', 'DTNBS030000001', NULL, 1000000, 'Debit', '2023-09-01 11:00:00', '2023-09-01 11:00:00'), -- Lê Ngọc Bích, Savings
('WDL', 'DTNBS030000002', NULL, 1200000, 'Debit', '2023-09-01 09:00:00', '2023-09-01 09:00:00'), -- Hoàng Thị Thanh Nhàn, Savings
('DEP', 'DTNBS230000001', NULL, 5000000, 'Credit', '2023-09-01 11:00:00', '2023-09-01 11:00:00'); -- Trần Thị Bích, Savings

-- 2023-10-01 (3 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('FEE', 'DTNBF230000002', NULL, 50000, 'Debit', '2023-10-01 11:00:00', '2023-10-01 11:00:00'), -- Nguyễn Phương Đông, Fixed
('WDL', 'DTNBC130000001', NULL, 10000000, 'Debit', '2023-10-01 10:00:00', '2023-10-01 10:00:00'), -- Lê Văn Cường, Checking, Overdraft
('WDL', 'DTNBS030000002', NULL, 1300000, 'Debit', '2023-10-01 10:00:00', '2023-10-01 10:00:00'); -- Hoàng Thị Thanh Nhàn, Savings

-- 2023-11-01 (2 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('TRF', 'DTNBC130000001', 'DTNBC130000001', 1000000, 'Debit', '2023-11-01 11:00:00', '2023-11-01 11:00:00'), -- Lê Văn Cường, Checking, Self-transfer
('DEP', 'DTNBF230000002', NULL, 6000000, 'Credit', '2023-11-01 13:00:00', '2023-11-01 13:00:00'); -- Nguyễn Phương Đông, Fixed

-- 2023-12-01 (5 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('TRF', 'DTNBC130000001', 'INVALID123', 1200000, 'Debit', '2023-12-01 12:00:00', '2023-12-01 12:00:00'), -- Lê Văn Cường, Checking, Invalid account
('INT', 'DTNBS230000001', NULL, 110000, 'Credit', '2023-12-01 08:00:00', '2023-12-01 08:00:00'), -- Trần Thị Bích, Savings
('INT', 'DTNBS220000002', NULL, 140000, 'Credit', '2023-12-01 08:00:00', '2023-12-01 08:00:00'), -- Phạm Vân Thư, Savings
('INT', 'DTNBF230000001', NULL, 210000, 'Credit', '2023-12-01 08:00:00', '2023-12-01 08:00:00'), -- Nguyễn Văn An, Fixed
('DEP', 'DTNBF230000002', NULL, 5000000, 'Credit', '2023-12-01 14:00:00', '2023-12-01 14:00:00'); -- Nguyễn Phương Đông, Fixed

-- 2024-01-01 (3 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('TRF', 'DTNBC130000001', 'DTNBS220000001', 1500000, 'Debit', '2024-01-01 13:00:00', '2024-01-01 13:00:00'), -- Lê Văn Cường, Checking
('TRF', 'DTNBS030000002', 'DTNBC220000001', 20000000, 'Debit', '2024-01-01 13:00:00', '2024-01-01 13:00:00'), -- Hoàng Thị Thanh Nhàn, Savings, Overdraft
('DEP', 'DTNBF230000001', NULL, 4000000, 'Credit', '2024-01-01 15:00:00', '2024-01-01 15:00:00'); -- Nguyễn Văn An, Fixed

-- 2024-02-01 (2 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('TRF', 'DTNBC130000001', 'DTNBS230000001', 1400000, 'Debit', '2024-02-01 14:00:00', '2024-02-01 14:00:00'), -- Lê Văn Cường, Checking
('PMT', 'DTNBS030000002', NULL, 1000000, 'Debit', '2024-02-01 14:00:00', '2024-02-01 14:00:00'); -- Hoàng Thị Thanh Nhàn, Savings

-- 2024-03-01 (3 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('PMT', 'DTNBC130000001', NULL, 1000000, 'Debit', '2024-03-01 15:00:00', '2024-03-01 15:00:00'), -- Lê Văn Cường, Checking
('PMT', 'DTNBS030000002', NULL, 1100000, 'Debit', '2024-03-01 15:00:00', '2024-03-01 15:00:00'), -- Hoàng Thị Thanh Nhàn, Savings
('INT', 'DTNBF230000001', NULL, 220000, 'Credit', '2024-03-01 08:00:00', '2024-03-01 08:00:00'); -- Nguyễn Văn An, Fixed

-- 2024-04-01 (2 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('PMT', 'DTNBC130000001', NULL, 1100000, 'Debit', '2024-04-01 16:00:00', '2024-04-01 16:00:00'), -- Lê Văn Cường, Checking
('ACH', 'DTNBS030000002', NULL, 1200000, 'Debit', '2024-04-01 16:00:00', '2024-04-01 16:00:00'); -- Hoàng Thị Thanh Nhàn, Savings

-- 2024-05-01 (2 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('ACH', 'DTNBC130000001', NULL, 1200000, 'Debit', '2024-05-01 09:00:00', '2024-05-01 09:00:00'), -- Lê Văn Cường, Checking
('TRF', 'DTNBF230000001', 'INVALID123', 5000000, 'Debit', '2024-05-01 13:00:00', '2024-05-01 13:00:00'); -- Nguyễn Văn An, Fixed, Invalid account

-- 2024-06-01 (5 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('ACH', 'DTNBC130000001', NULL, 1300000, 'Debit', '2024-06-01 10:00:00', '2024-06-01 10:00:00'), -- Lê Văn Cường, Checking
('INT', 'DTNBS230000001', NULL, 130000, 'Credit', '2024-06-01 08:00:00', '2024-06-01 08:00:00'), -- Trần Thị Bích, Savings
('INT', 'DTNBS220000002', NULL, 150000, 'Credit', '2024-06-01 08:00:00', '2024-06-01 08:00:00'), -- Phạm Vân Thư, Savings
('INT', 'DTNBS030000002', NULL, 150000, 'Credit', '2024-06-01 08:00:00', '2024-06-01 08:00:00'), -- Hoàng Thị Thanh Nhàn, Savings
('TRF', 'DTNBF230000001', 'DTNBS230000001', 30000000, 'Debit', '2024-06-01 14:00:00', '2024-06-01 14:00:00'); -- Nguyễn Văn An, Fixed, Overdraft

-- 2024-07-01 (2 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('CHK', 'DTNBC130000001', NULL, 2000000, 'Debit', '2024-07-01 11:00:00', '2024-07-01 11:00:00'), -- Lê Văn Cường, Checking
('POS', 'DTNBC240000001', NULL, 1400000, 'Debit', '2024-07-01 09:00:00', '2024-07-01 09:00:00'); -- Trần Thị Bích, Checking

-- 2024-08-01 (2 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('REF', 'DTNBC130000001', NULL, 1500000, 'Credit', '2024-08-01 12:00:00', '2024-08-01 12:00:00'), -- Lê Văn Cường, Checking
('POS', 'DTNBC240000001', NULL, 1600000, 'Debit', '2024-08-01 10:00:00', '2024-08-01 10:00:00'); -- Trần Thị Bích, Checking

-- 2024-09-01 (2 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('PMT', 'DTNBS230000001', NULL, 1000000, 'Debit', '2024-09-01 14:00:00', '2024-09-01 14:00:00'), -- Trần Thị Bích, Savings
('POS', 'DTNBC240000001', NULL, 1800000, 'Debit', '2024-09-01 11:00:00', '2024-09-01 11:00:00'); -- Trần Thị Bích, Checking

-- 2024-10-01 (1 transaction)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('POS', 'DTNBC240000001', NULL, 1000000, 'Debit', '2024-10-01 12:00:00', '2024-10-01 12:00:00'); -- Trần Thị Bích, Checking

-- 2024-11-01 (1 transaction)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('POS', 'DTNBC240000001', NULL, 10000000, 'Debit', '2024-11-01 13:00:00', '2024-11-01 13:00:00'); -- Trần Thị Bích, Checking, Overdraft

-- 2024-12-01 (2 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('WDL', 'DTNBC240000001', NULL, 1100000, 'Debit', '2024-12-01 14:00:00', '2024-12-01 14:00:00'), -- Trần Thị Bích, Checking
('INT', 'DTNBS030000002', NULL, 160000, 'Credit', '2024-12-01 08:00:00', '2024-12-01 08:00:00'); -- Hoàng Thị Thanh Nhàn, Savings

-- 2025-05-14 (10 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('DEP', 'DTNBS250000001', NULL, 5000000, 'Credit', '2025-05-14 14:00:00', '2025-05-14 14:00:00'), -- Nguyễn Thị Thu Trang, Savings
('DEP', 'DTNBF250000001', NULL, 9000000, 'Credit', '2025-05-14 14:00:00', '2025-05-14 14:00:00'), -- Nguyễn Thị Thu Trang, Fixed
('DEP', 'DTNBS250000001', NULL, 6000000, 'Credit', '2025-05-14 14:01:00', '2025-05-14 14:01:00'), -- Nguyễn Thị Thu Trang, Savings
('DEP', 'DTNBF250000001', NULL, 8000000, 'Credit', '2025-05-14 14:01:00', '2025-05-14 14:01:00'), -- Nguyễn Thị Thu Trang, Fixed
('DEP', 'DTNBS250000001', NULL, 7000000, 'Credit', '2025-05-14 14:02:00', '2025-05-14 14:02:00'), -- Nguyễn Thị Thu Trang, Savings
('DEP', 'DTNBF250000001', NULL, 7000000, 'Credit', '2025-05-14 14:02:00', '2025-05-14 14:02:00'), -- Nguyễn Thị Thu Trang, Fixed
('DEP', 'DTNBS250000001', NULL, 4000000, 'Credit', '2025-05-14 14:03:00', '2025-05-14 14:03:00'), -- Nguyễn Thị Thu Trang, Savings
('DEP', 'DTNBF250000001', NULL, 6000000, 'Credit', '2025-05-14 14:03:00', '2025-05-14 14:03:00'), -- Nguyễn Thị Thu Trang, Fixed
('DEP', 'DTNBS250000001', NULL, 8000000, 'Credit', '2025-05-14 14:04:00', '2025-05-14 14:04:00'), -- Nguyễn Thị Thu Trang, Savings
('FEE', 'DTNBF250000001', NULL, 50000, 'Debit', '2025-05-14 14:04:00', '2025-05-14 14:04:00'); -- Nguyễn Thị Thu Trang, Fixed

-- 2025-05-15 (2 transactions)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('WDL', 'DTNBS250000001', NULL, 1000000, 'Debit', '2025-05-15 14:00:00', '2025-05-15 14:00:00'), -- Nguyễn Thị Thu Trang, Savings
('TRF', 'DTNBF250000001', 'INVALID123', 15000000, 'Debit', '2025-05-15 14:00:00', '2025-05-15 14:00:00'); -- Nguyễn Thị Thu Trang, Fixed, Invalid account, Overdraft

-- 2025-05-16 (1 transaction)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('WDL', 'DTNBS250000001', NULL, 1100000, 'Debit', '2025-05-16 15:00:00', '2025-05-16 15:00:00'); -- Nguyễn Thị Thu Trang, Savings

-- 2025-05-17 (1 transaction)
INSERT INTO TRANSACTIONS (trans_type_id, cus_account_id, related_cus_account_id, trans_amount, direction, trans_time, last_updated) VALUES
('TRF', 'DTNBS250000001', 'DTNBF250000001', 1500000, 'Debit', '2025-05-17 16:00:00', '2025-05-17 16:00:00'); -- Nguyễn Thị Thu Trang, Savings, Self-transfer

use main;
INSERT INTO CUSTOMERS (
     cus_first_name, cus_last_name, cus_dob, cus_email, cus_address,
    cus_phone_num, cus_sex, cus_identification_id, cus_join_date, branch_id
) VALUES (
     'John', 'Doe', '1990-01-01', 'john@example.com', '123 Main St',
    '+84 901238881', 'Male', 'ID123456789', '2017-05-14', 'HN'
);
SELECT * FROM CUSTOMER_accounts;
-- Saving Account
INSERT INTO CUSTOMER_ACCOUNTS (
	cus_id, cus_account_status, cus_account_type_id, opening_date
) VALUES (
    'DTNBHN170000001',  'Active', 'S', '2017-05-14'
);

-- Checking Accounts
INSERT INTO CUSTOMER_ACCOUNTS (
    cus_id, cus_account_status, cus_account_type_id, opening_date
) VALUES
    ( 'DTNBHN170000001', 'Active', 'C', '2017-05-14'),
    ( 'DTNBHN170000001', 'Active', 'C', '2017-05-14'),
    ( 'DTNBHN170000001', 'Temporarily Locked', 'C', '2017-05-14');

-- Fixed Deposit Account
INSERT INTO CUSTOMER_ACCOUNTS (
     cus_id, cus_account_status, cus_account_type_id, opening_date
) VALUES (
    'DTNBHN170000001', 'Active', 'F', '2017-05-14'
);

-- Update Saving Account Balance
UPDATE SAVING_ACCOUNTS
SET saving_acc_balance = 200000
WHERE cus_account_id = 'DTNBS17000001';

-- Update Checking Account Balances and Limits
UPDATE CHECK_ACCOUNTS -- Check lỗi - 01
SET 
    check_acc_balance = 2000000, -- 2tr
    transfer_limit = 1500000, -- 1tr5
    daily_transfer_limit = 1900000 -- 1tr9
WHERE cus_account_id = 'DTNBC170000001';
select * from check_accounts;
UPDATE CHECK_ACCOUNTS -- Tk check daily trasfer 02
SET 
    check_acc_balance = 20000000,
    transfer_limit = 350000,
    daily_transfer_limit = 500000
WHERE cus_account_id = 'DTNBC170000002';

UPDATE CHECK_ACCOUNTS-- TK nhận tiền
SET 
    check_acc_balance = 2000000,
    daily_transfer_limit = 100000000
WHERE cus_account_id = 'DTNBC170000003';

-- Update Fixed Deposit Account Balance
UPDATE FIXED_DEPOSIT_ACCOUNTS
SET deposit_amount = 2000000
WHERE cus_account_id = 'DTNBHN170000001';


select * from TRANSACTION_ERROR_CODES;
select * from transactions;
select * from customer_accounts;
SELECT * 
FROM TRANSACTIONS
ORDER BY trans_time ASC;
############################################################
				-- CHECK TRANSACTION ERRORS --
############################################################

INSERT INTO TRANSACTIONS ( -- Check vượt daily_transfer_limit & gửi vào tk locked -- lỗi, lẽ ra phải check vượt tranfer_lim trước
    trans_type_id, cus_account_id, related_cus_account_id, trans_amount,
    direction, trans_time, last_updated,  trans_error_code
) VALUES
    ('TRF', 'DTNBC170000002', 'DTNBC170000001', 360000, 'Debit', '2017-05-14 14:12:00', '2017-05-14 14:12:00',  NULL), -- Exceeded the transaction limit
    ('TRF', 'DTNBC170000002', 'DTNBC170000001', 190000, 'Debit', '2017-05-14 14:12:00', '2017-05-14 14:12:00',  NULL), -- ok
    ('TRF', 'DTNBC170000002', 'DTNBC170000001', 290000, 'Debit', '2017-05-14 14:12:00', '2017-05-14 14:12:00',  NULL), -- ok
    ('TRF', 'DTNBC170000002', 'DTNBC170000001', 190000, 'Debit', '2017-05-14 14:12:00', '2017-05-14 14:12:00',  NULL), -- Exceeded the daily transaction limit  (190K+290K+190K < 500K)
    ('TRF', 'DTNBC170000002', 'DTNBC170000003', 1800, 'Debit', '2017-05-14 14:12:00', '2017-05-14 14:12:00',  NULL); -- The destination account has been locked
INSERT INTO TRANSACTIONS ( -- Source and destination accounts are the same
    trans_type_id, cus_account_id, related_cus_account_id, trans_amount,
    direction, trans_time, last_updated,  trans_error_code
) VALUES
    ( 'TRF', 'DTNBC170000001', 'DTNBC170000001', 40000000, 'Debit', '2017-05-14 14:14:00', '2017-05-14 14:14:00',  NULL);
INSERT INTO TRANSACTIONS ( -- Destination accounts is invalid
    trans_type_id, cus_account_id, related_cus_account_id, trans_amount,
    direction, trans_time, last_updated,  trans_error_code
) VALUES
    ( 'TRF', 'DTNBC170000001', 'DTNBS00000111', 17000000, 'Debit', '2017-05-14 14:16:00', '2017-05-14 14:16:00',  NULL);
############################################################
				-- CHECK FRAUD PATTERN --
############################################################
-- Locked Account for testing
SET SQL_SAFE_UPDATES = 0;
UPDATE CHECK_ACCOUNTS -- Tk check daily trasfer 02
SET 
    check_acc_balance = 20000000000000,
    transfer_limit = 9000000,
    daily_transfer_limit = 500000000000000
WHERE cus_account_id = 'DTNBC170000002';
-- Test case 2: 5 giao dịch trong 15 phút vượt 10x trung bình (trung bình ~1.4tr, 10x = 14tr)
-- Lower yearly average for ACC002 by inserting small transactions
-- Insert small transactions (before amount spike)
INSERT INTO TRANSACTIONS ( -- Check vượt daily_transfer_limit & gửi vào tk locked -- lỗi, lẽ ra phải check vượt tranfer_lim trước
    trans_type_id, cus_account_id, related_cus_account_id, trans_amount,
    direction, trans_time, last_updated
) VALUES
( 'TRF', 'DTNBC170000001', 'DTNBC170000001', 100000, 'Debit', DATE_SUB(NOW(), INTERVAL 350 DAY), DATE_SUB(NOW(), INTERVAL 350 DAY));
-- Insert small transactions (before amount spike)
INSERT INTO TRANSACTIONS ( -- Check vượt daily_transfer_limit & gửi vào tk locked -- lỗi, lẽ ra phải check vượt tranfer_lim trước
    trans_type_id, cus_account_id, related_cus_account_id, trans_amount,
    direction, trans_time, last_updated
) VALUES
( 'TRF', 'DTNBC170000002', 'DTNBC170000001', 100000, 'Debit', DATE_SUB(NOW(), INTERVAL 350 DAY), DATE_SUB(NOW(), INTERVAL 350 DAY)),
( 'TRF', 'DTNBC170000002', 'DTNBC170000001', 120000, 'Debit', DATE_SUB(NOW(), INTERVAL 330 DAY), DATE_SUB(NOW(), INTERVAL 330 DAY)),
( 'TRF', 'DTNBC170000002', 'DTNBC170000001', 95000,  'Debit', DATE_SUB(NOW(), INTERVAL 310 DAY), DATE_SUB(NOW(), INTERVAL 310 DAY)),
( 'TRF', 'DTNBC170000002', 'DTNBC170000001', 110000, 'Debit', DATE_SUB(NOW(), INTERVAL 290 DAY), DATE_SUB(NOW(), INTERVAL 290 DAY)),
( 'TRF', 'DTNBC170000002', 'DTNBC170000001', 105000, 'Debit', DATE_SUB(NOW(), INTERVAL 270 DAY), DATE_SUB(NOW(), INTERVAL 270 DAY)),
( 'TRF', 'DTNBC170000002', 'DTNBC170000001', 98000,  'Debit', DATE_SUB(NOW(), INTERVAL 240 DAY), DATE_SUB(NOW(), INTERVAL 240 DAY)),
( 'TRF', 'DTNBC170000002', 'DTNBC170000001', 102000, 'Debit', DATE_SUB(NOW(), INTERVAL 220 DAY), DATE_SUB(NOW(), INTERVAL 220 DAY)),
( 'TRF', 'DTNBC170000002', 'DTNBC170000001', 100000, 'Debit', DATE_SUB(NOW(), INTERVAL 200 DAY), DATE_SUB(NOW(), INTERVAL 200 DAY)),
(  'TRF', 'DTNBC170000002', 'DTNBC170000001', 99000,  'Debit', DATE_SUB(NOW(), INTERVAL 180 DAY), DATE_SUB(NOW(), INTERVAL 180 DAY)),
( 'TRF', 'DTNBC170000002', 'DTNBC170000001', 97000,  'Debit', DATE_SUB(NOW(), INTERVAL 160 DAY), DATE_SUB(NOW(), INTERVAL 160 DAY)),
( 'TRF', 'DTNBC170000002', 'DTNBC170000001', 103000, 'Debit', DATE_SUB(NOW(), INTERVAL 140 DAY), DATE_SUB(NOW(), INTERVAL 140 DAY)),
('TRF', 'DTNBC170000002', 'DTNBC170000001', 101000, 'Debit', DATE_SUB(NOW(), INTERVAL 120 DAY), DATE_SUB(NOW(), INTERVAL 120 DAY)),
( 'TRF', 'DTNBC170000002', 'DTNBC170000001', 95000,  'Debit', DATE_SUB(NOW(), INTERVAL 100 DAY), DATE_SUB(NOW(), INTERVAL 100 DAY)),
(  'TRF', 'DTNBC170000002', 'DTNBC170000001', 98000,  'Debit', DATE_SUB(NOW(), INTERVAL 80 DAY), DATE_SUB(NOW(), INTERVAL 80 DAY)),
('TRF', 'DTNBC170000002', 'DTNBC170000001', 99000,  'Debit', DATE_SUB(NOW(), INTERVAL 60 DAY), DATE_SUB(NOW(), INTERVAL 60 DAY)),
( 'TRF', 'DTNBC170000002', 'DTNBC170000001', 96000,  'Debit', DATE_SUB(NOW(), INTERVAL 40 DAY), DATE_SUB(NOW(), INTERVAL 40 DAY)),
(  'TRF', 'DTNBC170000002', 'DTNBC170000001', 97000,  'Debit', DATE_SUB(NOW(), INTERVAL 20 DAY), DATE_SUB(NOW(), INTERVAL 20 DAY));


-- Insert the large spike transactions (these should come after the small ones)
INSERT INTO TRANSACTIONS  ( 
    trans_type_id, cus_account_id, related_cus_account_id, trans_amount,
    direction, trans_time, last_updated
) VALUES
('TRF', 'DTNBC170000002', 'DTNBC170000001', 3000000, 'Debit', DATE_SUB(NOW(), INTERVAL 15 MINUTE), DATE_SUB(NOW(), INTERVAL 15 MINUTE)),
('TRF', 'DTNBC170000002', 'DTNBC170000001', 3500000, 'Debit', DATE_SUB(NOW(), INTERVAL 12 MINUTE), DATE_SUB(NOW(), INTERVAL 12 MINUTE)),
('TRF', 'DTNBC170000002', 'DTNBC170000001', 4000000, 'Debit', DATE_SUB(NOW(), INTERVAL 11 MINUTE), DATE_SUB(NOW(), INTERVAL 10 MINUTE)),
('TRF', 'DTNBC170000002', 'DTNBC170000001', 2500000, 'Debit', DATE_SUB(NOW(), INTERVAL 9 MINUTE), DATE_SUB(NOW(), INTERVAL 8 MINUTE)),
('TRF', 'DTNBC170000002', 'DTNBC170000001', 3000000, 'Debit', DATE_SUB(NOW(), INTERVAL 8 MINUTE), DATE_SUB(NOW(), INTERVAL 5 MINUTE)),
('TRF', 'DTNBC170000002', 'DTNBC170000001', 3000000, 'Debit', DATE_SUB(NOW(), INTERVAL 7 MINUTE), DATE_SUB(NOW(), INTERVAL 3 MINUTE)),
('TRF', 'DTNBC170000002', 'DTNBC170000001', 3000000, 'Debit', DATE_SUB(NOW(), INTERVAL 6 MINUTE), DATE_SUB(NOW(), INTERVAL 2 MINUTE)),
('TRF', 'DTNBC170000002', 'DTNBC170000001', 3000000, 'Debit', DATE_SUB(NOW(), INTERVAL 5 MINUTE), DATE_SUB(NOW(), INTERVAL 5 MINUTE)),
('TRF', 'DTNBC170000002', 'DTNBC170000001', 3000000, 'Debit', DATE_SUB(NOW(), INTERVAL 4 MINUTE), DATE_SUB(NOW(), INTERVAL 3 MINUTE)),
('TRF', 'DTNBC170000002', 'DTNBC170000001', 3000000, 'Debit', DATE_SUB(NOW(), INTERVAL 2 MINUTE), DATE_SUB(NOW(), INTERVAL 2 MINUTE));
-- Tạo khách hàng mới
select * from customer_accounts;
select * from suspicions;
-- Gắn tài khoản với khách hàng
INSERT INTO CUSTOMER_ACCOUNTS (
    cus_account_id, cus_id, cus_account_status, cus_account_type_id
)
VALUES (
    'ACC003', 'CUS001', 'Active', 'C'
);
UPDATE CHECK_ACCOUNTS
SET check_acc_balance = 200000000
    WHERE cus_account_id = "ACC003" ;
INSERT INTO TRANSACTIONS (
    trans_id, trans_type_id, cus_account_id, related_cus_account_id, trans_amount,
    direction, trans_time, last_updated, trans_status
)
VALUES (
    'AS301', 'TRF', 'ACC003', 'ACC001', 100000, 'Debit',
    DATE_SUB(NOW(), INTERVAL 100 DAY), DATE_SUB(NOW(), INTERVAL 100 DAY), 'Successful'
);
INSERT INTO TRANSACTIONS (
    trans_id, trans_type_id, cus_account_id, related_cus_account_id, trans_amount,
    direction, trans_time, last_updated, trans_status
)
VALUES (
    'AS302', 'TRF', 'ACC003', 'ACC001', 80000000, 'Debit',
    NOW(), NOW(), 'Successful'
);
select * from event_log;
select * from TEMP_suspicions;
select * from suspicions;



-- INSERT INTO CHECK_ACCOUNTS VALUES ('DTNBC25000011', 50000000 ,1, 100000, 1000000);
-- INSERT INTO TRANSACTIONS VALUES ('TXN007', 'TRF', 'DTNBC25000011', 'DTNBS25000001', 500000, 'Debit', NOW(), NOW(), 'Successful', NULL);



